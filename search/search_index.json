{"config":{"indexing":"full","lang":["zh"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to Turbo-v10's Documentation #","title":"Home"},{"location":"#welcome-to-turbo-v10s-documentation","text":"","title":"Welcome to Turbo-v10's Documentation"},{"location":"my-cicd/github-actions/","text":"Overview # GitHub Actions\u662f\u4e00\u4e2a\u6301\u7eed\u96c6\u6210\u6301\u7eed\u90e8\u7f72(CI/CD)\u7684\u5e73\u53f0\u3002\u5b83\u53ef\u4ee5\u81ea\u52a8\u5316\u4f60\u7684\u6784\u5efa\u3001\u6d4b\u8bd5\u3001\u90e8\u7f72\u6d41\u7a0b\u7b49\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Git\u4ed3\u5e93\u91cc\u7684\u5404\u79cd\u4e8b\u4ef6\u6765\u89e6\u53d1GitHub Actions\u7684\u6d41\u7a0b\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u8bbe\u7f6e\u6d41\u7a0b\u5728\u4efb\u4f55Pull Request\u88ab\u521b\u5efa\u7684\u65f6\u5019\u89e6\u53d1\u3002 GitHub\u63d0\u4f9b\u4e86Linux\u3001Windows\u3001MacOS\u64cd\u4f5c\u7cfb\u7edf\u7684\u865a\u62df\u673a\uff0c\u6765\u6267\u884c\u4f60\u7684\u81ea\u52a8\u5316\u6d41\u7a0b\u3002 \u4f60\u751a\u81f3\u53ef\u4ee5\u7ba1\u7406\u8fd0\u884c\u5728\u4f60\u81ea\u5df1\u6570\u636e\u4e2d\u5fc3\u6216\u8005\u4e91\u5e73\u53f0\u4e0a\u7684\u670d\u52a1\u5668\uff0c\u628a\u5b83\u4f5c\u4e3a\u8fd0\u884cGitHub Actions\u7684\u6d41\u7a0b\u7684\u5bbf\u4e3b\u673a\u3002 \u6982\u5ff5\uff1a\u7ec4\u4ef6 # GitHub Actions\u4e2d\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u8981\u7d20\uff1a Workflows\uff08\u6d41\u7a0b\uff09 Events\uff08\u4e8b\u4ef6\uff09 Jobs\uff08\u4efb\u52a1\uff09 Actions\uff08\u52a8\u4f5c\uff09 Runners\uff08\u8fd0\u884c\u5668\uff09 Workflows\uff08\u6d41\u7a0b\uff09 # Workflows\u5b9a\u4e49\u5728 .github/workflows \u76ee\u5f55\u4e0b Events\uff08\u4e8b\u4ef6\uff09 # TODO Jobs\uff08\u4efb\u52a1\uff09 # \u4efb\u52a1\uff0c\u662f\u6d41\u7a0b\u4e2d\u4e00\u7cfb\u5217\u6b65\u9aa4(steps)\u7684\u96c6\u5408\u3002 TODO Actions\uff08\u52a8\u4f5c\uff09 # An action is a custom application for the GitHub Actions platform that performs a complex but frequently repeated task. Use an action to help reduce the amount of repetitive code that you write in your workflow files. Runners\uff08\u8fd0\u884c\u5668\uff09 # Runner\u662f\u8fd0\u884cWorkflows\u7684\u670d\u52a1\u5668\u3002\u6bcf\u4e00\u4e2aRunner\u5728\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2aJob\u3002 GitHub\u63d0\u4f9b\u4e86Ubuntu Linux\uff0cMicrosoft Windows\uff0cMacOS\u7684Runner\u6765\u8fd0\u884c\u4f60\u7684Workflow\uff0c\u5e76\u4e14\u6bcf\u4e2aWorkflow\u5c06\u4f1a\u5728\u4e00\u4e2a\u5168\u65b0\u6784\u5efa\u7684\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u3002 \u8bf7\u53c2\u8003GitHub\u5df2\u63d0\u4f9b\u7684Runner\u89c4\u683c About GitHub-hosted runners GitHub\u4e5f\u63d0\u4f9b\u4e86\u66f4\u5927\u578b\u7684Runner\uff0c\u8bf7\u53c2\u8003 Using larger runners \u5982\u679c\u4f60\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6216\u8005\u9700\u8981\u4e00\u53f0\u7279\u6b8a\u786c\u4ef6\u89c4\u683c\u7684\u673a\u5668\u3002 \u4f60\u53ef\u4ee5\u7ba1\u7406\u81ea\u5df1\u7684\u670d\u52a1\u5668\u3002\u53c2\u8003 Hosting your own runners \u6982\u5ff5\uff1a\u6d41\u7a0b\u7684\u5b9a\u4e49\u6587\u4ef6 # Finding and Customizing Actions # \u5728Workflow\u4e2d\u4f7f\u7528\u7684Action\u53ef\u4ee5\u88ab\u5b9a\u4e49\u5728: \u540c\u4e00\u4e2a\u4ed3\u5e93(repository)\uff0c\u4f5c\u4e3aWorkflow\u6587\u4ef6 \u4efb\u4f55\u516c\u5171\u4ed3\u5e93 DockerHub\u4e0a\u516c\u5f00\u7684Docker\u955c\u50cf","title":"GitHub Actions"},{"location":"my-cicd/github-actions/#overview","text":"GitHub Actions\u662f\u4e00\u4e2a\u6301\u7eed\u96c6\u6210\u6301\u7eed\u90e8\u7f72(CI/CD)\u7684\u5e73\u53f0\u3002\u5b83\u53ef\u4ee5\u81ea\u52a8\u5316\u4f60\u7684\u6784\u5efa\u3001\u6d4b\u8bd5\u3001\u90e8\u7f72\u6d41\u7a0b\u7b49\u3002 \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Git\u4ed3\u5e93\u91cc\u7684\u5404\u79cd\u4e8b\u4ef6\u6765\u89e6\u53d1GitHub Actions\u7684\u6d41\u7a0b\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u8bbe\u7f6e\u6d41\u7a0b\u5728\u4efb\u4f55Pull Request\u88ab\u521b\u5efa\u7684\u65f6\u5019\u89e6\u53d1\u3002 GitHub\u63d0\u4f9b\u4e86Linux\u3001Windows\u3001MacOS\u64cd\u4f5c\u7cfb\u7edf\u7684\u865a\u62df\u673a\uff0c\u6765\u6267\u884c\u4f60\u7684\u81ea\u52a8\u5316\u6d41\u7a0b\u3002 \u4f60\u751a\u81f3\u53ef\u4ee5\u7ba1\u7406\u8fd0\u884c\u5728\u4f60\u81ea\u5df1\u6570\u636e\u4e2d\u5fc3\u6216\u8005\u4e91\u5e73\u53f0\u4e0a\u7684\u670d\u52a1\u5668\uff0c\u628a\u5b83\u4f5c\u4e3a\u8fd0\u884cGitHub Actions\u7684\u6d41\u7a0b\u7684\u5bbf\u4e3b\u673a\u3002","title":"Overview"},{"location":"my-cicd/github-actions/#_1","text":"GitHub Actions\u4e2d\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u8981\u7d20\uff1a Workflows\uff08\u6d41\u7a0b\uff09 Events\uff08\u4e8b\u4ef6\uff09 Jobs\uff08\u4efb\u52a1\uff09 Actions\uff08\u52a8\u4f5c\uff09 Runners\uff08\u8fd0\u884c\u5668\uff09","title":"\u6982\u5ff5\uff1a\u7ec4\u4ef6"},{"location":"my-cicd/github-actions/#workflows","text":"Workflows\u5b9a\u4e49\u5728 .github/workflows \u76ee\u5f55\u4e0b","title":"Workflows\uff08\u6d41\u7a0b\uff09"},{"location":"my-cicd/github-actions/#events","text":"TODO","title":"Events\uff08\u4e8b\u4ef6\uff09"},{"location":"my-cicd/github-actions/#jobs","text":"\u4efb\u52a1\uff0c\u662f\u6d41\u7a0b\u4e2d\u4e00\u7cfb\u5217\u6b65\u9aa4(steps)\u7684\u96c6\u5408\u3002 TODO","title":"Jobs\uff08\u4efb\u52a1\uff09"},{"location":"my-cicd/github-actions/#actions","text":"An action is a custom application for the GitHub Actions platform that performs a complex but frequently repeated task. Use an action to help reduce the amount of repetitive code that you write in your workflow files.","title":"Actions\uff08\u52a8\u4f5c\uff09"},{"location":"my-cicd/github-actions/#runners","text":"Runner\u662f\u8fd0\u884cWorkflows\u7684\u670d\u52a1\u5668\u3002\u6bcf\u4e00\u4e2aRunner\u5728\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2aJob\u3002 GitHub\u63d0\u4f9b\u4e86Ubuntu Linux\uff0cMicrosoft Windows\uff0cMacOS\u7684Runner\u6765\u8fd0\u884c\u4f60\u7684Workflow\uff0c\u5e76\u4e14\u6bcf\u4e2aWorkflow\u5c06\u4f1a\u5728\u4e00\u4e2a\u5168\u65b0\u6784\u5efa\u7684\u865a\u62df\u673a\u4e0a\u8fd0\u884c\u3002 \u8bf7\u53c2\u8003GitHub\u5df2\u63d0\u4f9b\u7684Runner\u89c4\u683c About GitHub-hosted runners GitHub\u4e5f\u63d0\u4f9b\u4e86\u66f4\u5927\u578b\u7684Runner\uff0c\u8bf7\u53c2\u8003 Using larger runners \u5982\u679c\u4f60\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6216\u8005\u9700\u8981\u4e00\u53f0\u7279\u6b8a\u786c\u4ef6\u89c4\u683c\u7684\u673a\u5668\u3002 \u4f60\u53ef\u4ee5\u7ba1\u7406\u81ea\u5df1\u7684\u670d\u52a1\u5668\u3002\u53c2\u8003 Hosting your own runners","title":"Runners\uff08\u8fd0\u884c\u5668\uff09"},{"location":"my-cicd/github-actions/#_2","text":"","title":"\u6982\u5ff5\uff1a\u6d41\u7a0b\u7684\u5b9a\u4e49\u6587\u4ef6"},{"location":"my-cicd/github-actions/#finding-and-customizing-actions","text":"\u5728Workflow\u4e2d\u4f7f\u7528\u7684Action\u53ef\u4ee5\u88ab\u5b9a\u4e49\u5728: \u540c\u4e00\u4e2a\u4ed3\u5e93(repository)\uff0c\u4f5c\u4e3aWorkflow\u6587\u4ef6 \u4efb\u4f55\u516c\u5171\u4ed3\u5e93 DockerHub\u4e0a\u516c\u5f00\u7684Docker\u955c\u50cf","title":"Finding and Customizing Actions"},{"location":"my-cicd/harness/","text":"","title":"Harness"},{"location":"my-cloudnative/cert-manager/","text":"cert-manager # SSL # https://cert-manager.io https://github.com/cert-manager/cert-manager https://juejin.cn/post/7046722328008327198 https://imroc.cc/k8s/trick/sign-free-certs-with-cert-manager/","title":"cert-manager"},{"location":"my-cloudnative/cert-manager/#cert-manager","text":"","title":"cert-manager"},{"location":"my-cloudnative/cert-manager/#ssl","text":"https://cert-manager.io https://github.com/cert-manager/cert-manager https://juejin.cn/post/7046722328008327198 https://imroc.cc/k8s/trick/sign-free-certs-with-cert-manager/","title":"SSL"},{"location":"my-cloudnative/cloud-native-fundamentals/","text":"","title":"Cloud Native Fundamentals"},{"location":"my-cloudnative/containerd/","text":"","title":"containerd"},{"location":"my-docs/mkdocs/","text":"Welcome to MkDocs # MkDocs is a fast, simple and downright gorgeous static site generator that's geared towards building project documentation. Documentation source files are written in Markdown, and configured with a single YAML configuration file. Start by reading the introductory tutorial, then check the User Guide for more information. For full documentation visit mkdocs.org . Commands # mkdocs new [dir-name] - Create a new project. mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. mkdocs help - Print this help message. Project layout # mkdocs.yml # The configuration file. docs/ index.md # The documentation homepage. ... # Other markdown pages, images and other files. Plugins # mermaid2 # https://github.com/fralau/mkdocs-mermaid2-plugin","title":"MkDocs"},{"location":"my-docs/mkdocs/#welcome-to-mkdocs","text":"MkDocs is a fast, simple and downright gorgeous static site generator that's geared towards building project documentation. Documentation source files are written in Markdown, and configured with a single YAML configuration file. Start by reading the introductory tutorial, then check the User Guide for more information. For full documentation visit mkdocs.org .","title":"Welcome to MkDocs"},{"location":"my-docs/mkdocs/#commands","text":"mkdocs new [dir-name] - Create a new project. mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. mkdocs help - Print this help message.","title":"Commands"},{"location":"my-docs/mkdocs/#project-layout","text":"mkdocs.yml # The configuration file. docs/ index.md # The documentation homepage. ... # Other markdown pages, images and other files.","title":"Project layout"},{"location":"my-docs/mkdocs/#plugins","text":"","title":"Plugins"},{"location":"my-docs/mkdocs/#mermaid2","text":"https://github.com/fralau/mkdocs-mermaid2-plugin","title":"mermaid2"},{"location":"my-kubernetes/k8s-lesson-20221124/","text":"Kubernetes \u57fa\u7840\u8bfe (2022-11-24) # Training of Cloud-Native Kubernetes for Development. \u5185\u5bb9\u63d0\u8981 Kubernetes \u5b58\u50a8 Kubernetes \u7f16\u7a0b(Controller\u3001Operator\u3001CRD) Kubernetes \u8c03\u5ea6\u4e0e\u8d44\u6e90\u7ba1\u7406 Kubernetes \u672a\u6765\u5c55\u671b Kubernetes \u5b58\u50a8 # \u6709\u72b6\u6001\u5e94\u7528\u7684\u5b58\u50a8\u72b6\u6001 # \u6709\u72b6\u6001\u5e94\u7528\u7684\u5b58\u50a8\u62d3\u6251 \u65e0\u72b6\u6001\u5e94\u7528\u4e0e\u5b58\u50a8\u5206\u79bb 1. \u5bb9\u5668\u6570\u636e\u7684\u672c\u5730(\u4e34\u65f6)\u5b58\u50a8 # \u5377(Volume):\u5c06\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee \u5f55\uff0c\u8ddf\u4e00\u4e2a\u5bb9\u5668\u91cc\u7684\u76ee\u5f55\u7ed1\u5b9a\u6302\u8f7d \u5728\u4e86\u4e00\u8d77\u3002 \u4f7f\u7528volumeMounts\u6302\u8f7d:\u58f0\u660e\u5377\u5728 \u5bb9\u5668\u4e2d\u7684\u6302\u8f7d\u4f4d\u7f6e \u672c\u5730\u5b58\u50a8\u5e38\u7528\u7c7b\u578b emptyDir hostPath \u672c\u5730\u5b58\u50a8 - emptyDir # \u4e0e Pod \u540c\u751f\u547d\u5468\u671f \u521d\u59cb\u5316\u540e\u4e3a\u7a7a \u7528\u9014 \u7f13\u5b58\u7a7a\u95f4 \u4e34\u65f6\u5b58\u50a8 Web server\u4fdd\u5b58\u6587\u4ef6 apiVersion: v1 kind: Pod metadata: name: temp-volume-pod spec: containers: - image: nginx name: nginx volumeMounts: - mountPath: /cache-volume name: cache-volume - mountPath: /test-hostpath name: test-volume volumes: - name: cache-volume emptyDir: {} - name: test-volume hostPath: path: /etc # \u5bbf\u4e3b\u4e0a\u76ee\u5f55\u4f4d\u7f6e type: Directory # \u53ef\u9009 \u672c\u5730\u5b58\u50a8 - hostPath # \u5c06\u5bbf\u4e3b\u673a\u76ee\u5f55\u6302\u8f7d\u5230Pod \u7528\u9014 \u9700\u8981\u8bbf\u95eeDocker\u5185\u90e8\u6587\u4ef6(/var/lib/docker) \u5728\u5bb9\u5668\u4e2d\u8fd0\u884ccAdvisor\u65f6\uff0c\u6302\u8f7d/sys\u3002 \u83b7\u53d6hostPath\u7684\u6570\u636e\u4f5c\u4e3aPod\u521b\u5efa\u7684\u524d\u7f6e\u6761\u4ef6 type\u7c7b\u578b DirectoryOrCreate Directory FileOrCreate File ...... \u5c3d\u91cf\u907f\u514d\u4f7f\u7528hostPat\uff0c\u6709\u98ce\u9669 \u6709\u9650\u4f7f\u7528 readonly\u6302\u8f7d 2. \u5bb9\u5668\u6570\u636e\u7684\u6301\u4e45\u5316\u5b58\u50a8 # \u672c\u5730\u4e34\u65f6\u5377\u7684\u7f3a\u70b9 \u4e0d\u80fd\u6301\u4e45\u5316;\u4e0d\u80fd\u5171\u4eab;\u4e0d\u80fd\u8fc1\u79fb \u6301\u4e45\u5316\u5377(Persistent Volume) \u72ec\u7acb\u4e8ePod\u751f\u547d\u5468\u671f \u89e3\u8026\u65e0\u72b6\u6001\u7684\u5e94\u7528\u548c\u6709\u72b6\u6001\u7684\u5b58\u50a8 \u57fa\u4e8e\u4e13\u95e8\u7684\u3001\u8fdc\u7a0b\u5b58\u50a8\u670d\u52a1 \u652f\u6301\u7c7b\u578b: \u4e91\u5e73\u53f0\u5b58\u50a8:AWS EBS\u3001AzureDisk\u7b49 CephFS\u3001CSI\u3001NFS\u7b49\u7b49 types-of-persistent-volumes PV \u548c PVC # PV(Persistentvolume) \u6301\u4e45\u5316\u5377 \u5b9a\u4e49\u4e00\u4e2a\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\u6216\u8fdc\u7aef PVC(Persistent volume claim) \u63cf\u8ff0Pod\u60f3\u4f7f\u7528\u7684\u5b58\u50a8\u76f8\u5173\u7684\u5c5e\u6027 \u5173\u7cfb\uff1a\u7c7b\u4f3c\u62bd\u8c61\u4e0e\u7ee7\u627f \u4e3a\u4ec0\u4e48\u8981\u8bbe\u8ba1PV\u3001PVC\uff1f \u7ba1\u7406\u5458\u5f00\u53d1PV\uff0c\u63d0\u4f9b\u63a5\u53e3 \u5f00\u53d1\u4eba\u5458\u5f00\u53d1PV\uff0c\u53ea\u9700\u8981\u5173\u5fc3\u4f7f\u7528\u7684\u6301\u4e45\u5316\u5b58\u50a8\u5c5e\u6027 PV(Persistent Volume) # \u6838\u5fc3\u5b57\u6bb5 capacity volumeMode accessMode persistentVolumeReclaimPolicy storageClassName mountOptions \u9636\u6bb5(phase) Available(\u53ef\u7528) Bound(\u5df2\u7ed1\u5b9a) Released(\u5df2\u91ca\u653e) Failed(\u5931\u8d25) PVC(Persistent Volume Claim) # \u63cf\u8ff0\u8981\u4f7f\u7528\u7684\u5b58\u50a8\u5c5e\u6027 \u65e0\u9700\u5173\u6ce8\u5b58\u50a8\u5b9e\u73b0 \u6838\u5fc3\u5b57\u6bb5 accessMode volumeMode resources storageClassName selector:matchLabels\u3001matchExpressions \u7ed1\u5b9a\u6761\u4ef6 spec \u5339\u914d StorageClassName \u4e00\u81f4 \u7ed1\u5b9a(provisioning)\u5de5\u4f5c\u539f\u7406 # \u4e24\u4e2a\u9636\u6bb5 Attach\u9636\u6bb5 Mount\u9636\u6bb5 \u63a7\u5236\u5668 AttachDetachController -> kube-controller-manager VolumeManagerReconciler -> worker node \u9759\u6001\u7ed1\u5b9a\u7684\u7f3a\u70b9 # \u7ba1\u7406\u5458\u9700\u8981\u624b\u52a8\u521b\u5efaPV\u3002\u96c6\u7fa4\u89c4\u6a21\u5927\u65f6\uff0c\u9700\u8981\u521b\u5efa\u4e00\u5927\u5806PV\uff0c\u7ef4\u62a4\u4e0d\u4fbf \u52a8\u6001\u7ed1\u5b9a(Dynamic Provisioning) # StorageClass \u521b\u5efaPV\u6a21\u677f \u4f7f\u7528 StorageClass \u52a8\u6001\u7ed1\u5b9a # \u5b58\u50a8\u7c7b(StorageClass) \u521b\u5efaPV\u6a21\u677f(\u5bf9\u8c61) \u5c5e\u6027 \u5b58\u50a8\u63d2\u4ef6 \u5b57\u6bb5 Provisioner Parameter reclaimPolicy \u56de\u6536\u7b56\u7565 \u5176\u4ed6 # \u8981\u5220\u9664PV/PVC\uff0c\u5148\u5220\u4f7f\u7528\u8005(Pod) \u751f\u4ea7\u73af\u5883\u4e00\u822c\u90fd\u662f\u901a\u8fc7\u52a8\u6001\u7ed1\u5b9a\u7684\u65b9\u5f0f 3. \u672c\u5730\u6301\u4e45\u5377 # Local Persistent Volume(LPV) \u672c\u5730\u5b58\u50a8\u9700\u6c42 (\u6027\u80fd) \u4e00\u822c\u662f\u989d\u5916\u78c1\u76d8\uff0c\u4e0d\u5e94\u4f7f\u7528\u672c\u5730\u78c1\u76d8 \u9650\u5236\uff1a \u4e0d\u652f\u6301\u52a8\u6001\u7ed1\u5b9a Node\u8c03\u5ea6\u95ee\u9898 \u8de8\u533a\u95ee\u9898 \u5fc5\u987b\u4f7f\u7528\u8282\u70b9\u4eb2\u548c\u6027nodeAffinity\u786e\u4fddpod\u88ab\u8c03\u5ea6\u5230\u5f53\u524dnode \u5ef6\u8fdf\u7ed1\u5b9a WaitForFirstConsumer \u7b49\u5f85Pod\u521b\u5efa \u7ed1\u5b9aPV\u548cPVC LPV\u7684\u5ef6\u8fdf\u7ed1\u5b9a # \u4f8b\u5982WaitForFirstConsumer \u4e3a\u4ec0\u4e48LPV\u8981\u6709\u5ef6\u8fdf\u7ed1\u5b9a\uff1f \u8c03\u5ea6\u5668\u8003\u8651\u5377\u5206\u5e03\u7684\u539f\u5219\uff0c\u9632\u6b62Pod\u88ab\u4eb2\u548c\u6027\u7ed1\u5b9a\u81f3\u4e0d\u540c\u7684node \u5bb9\u5668\u5b58\u50a8\u63a5\u53e3 - CSI # \u5bb9\u5668\u5b58\u50a8\u63a5\u53e3 \u7ec4\u4ef6 DriverRegistrar ExternalProvisioner ExternalAttacher CSI\u63d2\u4ef6\u670d\u52a1 Identity Controller Node \u9700\u8981\u5f00\u53d1\u81ea\u5b9a\u4e49\u5b58\u50a8\u63a5\u53e3\u65f6\uff0c\u53c2\u8003 https://github.com/container-storage-interface/spec Kubernetes \u5b58\u50a8\u5c0f\u7ed3 # \u4e34\u65f6\u5377 \u6301\u4e45\u5316\u5377 \u9759\u6001\u3001\u52a8\u6001\u7ed1\u5b9a \u672c\u5730\u6301\u4e45\u5377 CSI\u63a5\u53e3 Kubernetes \u7f16\u7a0b\u8303\u5f0f # \u4ec0\u4e48\u662f\u7f16\u7a0b\u8303\u5f0f # Programming paradigm\uff0c\u53c8\u53eb\u7f16\u7a0b\u8303\u578b\u3001\u7f16\u7a0b\u8303\u5f0f\u6216\u7a0b\u5e8f\u8bbe\u8ba1\u6cd5\uff0c\u662f\u6307\u8f6f \u4ef6\u5de5\u7a0b\u4e2d\u7684\u4e00\u7c7b\u5178\u578b\u7684\u7f16\u7a0b\u98ce\u683c\u3002 \u5206\u7c7b \u547d\u4ee4\u5f0f\u7f16\u7a0b \u9762\u5411\u8fc7\u7a0b\u7f16\u7a0b \u9762\u5411\u5bf9\u8c61\u7f16\u7a0b \u51fd\u6570\u5f0f\u7f16\u7a0b Kubernetes\u7684\u7f16\u7a0b\u8303\u5f0f/\u98ce\u683c? \u58f0\u660e\u5f0f\u7f16\u7a0b # \u58f0\u660e\u5f0f\u7f16\u7a0b(Declarative programming)\u662f\u4e00\u79cd\u7f16\u7a0b\u8303\u5f0f\uff0c\u4e0e\u547d\u4ee4\u5f0f\u7f16\u7a0b\u76f8\u5bf9\u7acb\u3002 \u5b83\u63cf\u8ff0\u60f3\u8981\u8fbe\u5230\u7684\u76ee\u6807\u72b6\u6001\uff0c\u8ba9\u8ba1\u7b97\u673a(\u5de5\u5177)\u5185\u90e8\u81ea\u5df1\u5b9e\u73b0\u5982\u4f55\u8fbe\u5230\u76ee\u6807\u3002 \u800c\u547d\u4ee4\u5f0f\u7f16\u7a0b\u5219\u9700\u8981\u7528\u7b97\u6cd5\u6765\u660e\u786e\u7684\u6307\u51fa\u6bcf\u4e00\u6b65\u8be5\u600e\u4e48\u505a\u3002 \u547d\u4ee4\u5f0f(Imperative):\u544a\u8bc9\u7cfb\u7edf\u600e\u4e48\u505a(\u4e00\u7cfb\u5217\u52a8\u4f5c) \u58f0\u660e\u5f0f(Declarative):\u544a\u8bc9\u7cfb\u7edf\u8981\u4ec0\u4e48(\u76ee\u6807\u72b6\u6001) Kubernetes \u91cc\u7684\u58f0\u660e\u5f0fAPI # create\u3001replace\u3001apply\uff0c\u54ea\u4e2a\u624d\u662f\u58f0\u660e\u5f0f? \u58f0\u660e\u5f0fAPI\u7684\u80fd\u529b:Patch Kubernetes \u7f16\u6392\u6838\u5fc3:\u58f0\u660e\u3001\u5b9a\u4e49\u3001\u8c03\u8c10(reconcile) Kubernetes API\u5bf9\u8c61 # \u64cd\u4f5cKubernetes\u5bf9\u8c61(CRUD)\u90fd\u9700\u8981\u4f7f\u7528KubernetesAPI \u6811\u5f62\u7ed3\u6784 \u8d44\u6e90\u8def\u5f84 Group Version Resource \u6838\u5fc3\u5bf9\u8c61\u6ca1\u6709Group Group\u901a\u8fc7\u529f\u80fd\u5212\u5206 \u652f\u6301\u591a\u7248\u672c API\u6269\u5c55 \u81ea\u5b9a\u4e49\u8d44\u6e90(CRD) \u805a\u5408\u5c42 Kubernetes \u58f0\u660e\u5f0fAPI\u5de5\u4f5c\u539f\u7406 # \u89e3\u6790\u8fc7\u7a0b \u5339\u914d\u7ec4 \u5339\u914d\u7248\u672c \u5339\u914d\u8d44\u6e90\u7c7b\u578b \u5bf9\u8c61\u521b\u5efa\u8fc7\u7a0b \u53d1\u8d77\u521b\u5efa\u8bf7\u6c42 \u8fc7\u6ee4 \u7ed1\u5b9a\u5904\u7406\u5668(\u589e\u5220\u6539\u67e5\u5bf9\u5e94\u7684handler) \u627e\u5230\u5bf9\u8c61\u5b9a\u4e49 \u521b\u5efa\u8d44\u6e90 \u51c6\u5165\u3001\u9a8c\u8bc1 \u5e8f\u5217\u5316\u5b58\u50a8 API \u8bf7\u6c42\u751f\u547d\u5468\u671f # Request -> API HTTP handler -> \u9274\u6743(authentication/authorization) -> \u53d8\u66f4\u51c6\u5165\u63a7\u5236\u5668 mutating admission controller <-> mutating admission webhooks -> object schema validation -> \u9a8c\u8bc1\u51c6\u5165\u63a7\u5236\u5668 validating admission controller <-> validating admission webhooks -> persisted to ETCD Kubernetes \u7f16\u7a0b\u6838\u5fc3 - Controller # \u4e00\u4e2a\u63a7\u5236\u5668\u81f3\u5c11\u8ffd\u8e2a\u67d0\u79cd\u8d44\u6e90\uff0c\u8d1f\u8d23\u5c06\u8d44\u6e90\u7684\u5f53\u524d\u72b6\u6001\u4fee\u6539\u4e3a\u7528\u6237\u671f\u671b\u7684\u72b6\u6001 \uff08\u5373\u8c03\u534f\u8fc7\u7a0b\uff09 \u73b0\u5b9e\u6001 -> \u671f\u671b\u6001 \uff08\u9762\u5411\u7ec8\u6001\u7684\u8bbe\u8ba1\uff09 \u63a7\u5236\u5faa\u73af Control loop \u5185\u7f6e\u63a7\u5236\u5668 \u81ea\u5b9a\u4e49\u63a7\u5236\u5668 \u63a7\u5236\u5668\u5de5\u4f5c\u539f\u7406 # \u5b9e\u73b0\u6d41\u7a0b * main\u51fd\u6570 * \u63a7\u5236\u5668\u7684\u5b9a\u4e49 * \u63a7\u5236\u5668\u4e1a\u52a1\u903b\u8f91 API Server -> Informer -> Work Queue -> Control Loop Informer \u603b\u7ed3 # \u5e26\u6709\u672c\u5730\u7f13\u5b58\u548c\u7d22\u5f15\u673a\u5236\u7684\u3001\u53ef\u4ee5\u6ce8\u518c EventHandler \u7684 client \u5b83\u662f\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u8ddfAPIServer\u8fdb\u884c\u6570\u636e\u540c\u6b65\u7684 \u91cd\u8981\u7ec4\u4ef6 \u901a\u8fc7ListAndWatch\u7684\u65b9\u6cd5\uff0c\u628aAPIServer\u4e2d\u7684 API\u5bf9\u8c61\u7f13\u5b58\u5728\u4e86\u672c\u5730\uff0c\u5e76\u8d1f\u8d23\u66f4\u65b0\u548c\u7ef4\u62a4\u8fd9\u4e2a \u7f13\u5b58 \u804c\u8d23\u4e00:\u83b7\u53d6\u5bf9\u8c61\u53d8\u5316\uff0c\u66f4\u65b0\u672c\u5730\u7f13\u5b58 \u804c\u8d23\u4e8c:\u6839\u636e\u4e8b\u4ef6\uff0c\u89e6\u53d1\u5bf9\u5e94\u7684\u5904\u7406\u5668 Controller \u603b\u7ed3 # \u8c03\u7528controller.Run()\u542f\u52a8\u201c\u63a7\u5236\u5faa\u73af\u201d \u7b49\u5f85Informer\u5b8c\u6210\u4e00\u6b21\u672c\u5730\u7f13\u5b58\u7684\u6570\u636e\u540c\u6b65\u64cd\u4f5c \u901a\u8fc7goroutine\u542f\u52a8\u4e00\u4e2a\u201c\u65e0\u9650\u5faa\u73af\u201d\u7684\u4efb\u52a1\u3002\u6bcf\u4e00\u4e2a\u5faa\u73af\u5468\u671f\uff0c\u6267\u884c\u4e1a\u52a1\u903b\u8f91 \u4e1a\u52a1\u903b\u8f91: \u51fa\u961f\u5217\uff0c\u62ff\u5230key\uff0c\u4eceinformer\u7f13\u5b58\u4e2d\u62ff\u5230\u5bf9\u8c61 \u5bf9\u6bd4\u201c\u671f\u671b\u72b6\u6001\u201d\u548c\u201c\u5b9e\u9645\u72b6\u6001\u201d\uff0c\u5b8c\u6210\u8c03\u8c10reconcile\u8fc7\u7a0b Kubernetes \u7f16\u7a0b\u8303\u5f0f\u7684\u6838\u5fc3\u601d\u8def # Informer\uff0c\u5c31\u662f\u4e00\u4e2a\u81ea\u5e26\u7f13\u5b58\u548c\u7d22\u5f15\u673a\u5236\uff0c\u53ef\u4ee5\u89e6\u53d1Handler\u7684\u5ba2\u6237\u7aef\u5e93 \u4f7f\u7528Reflector\u5305\uff0c\u901a\u8fc7ListAndWatch\u673a\u5236\u83b7\u53d6\u5e76\u76d1\u89c6API\u5bf9\u8c61\u53d8\u5316 \u5165\u961f\u534f\u540c(Informer & reflector):DeltaFIFOQueue \u51fa\u961f\u534f\u540c(Informer & control loop):WorkQueue \u5b9e\u73b0\u671f\u671b\u72b6\u6001\u4e0e\u5b9e\u9645\u72b6\u6001\u7684\u8c03\u8c10(reconcile) \u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49(CRD) # Why K8S\u73b0\u6709\u8d44\u6e90\u4e0d\u80fd\u6ee1\u8db3\u9700\u6c42 \u81ea\u5b9a\u4e49\u8d44\u6e90 - CR \u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49 - CRD \u81ea\u5b9a\u4e49\u63a7\u5236\u5668 CRD\u662f\u62bd\u8c61 -> schema level CR\u662f\u5b9e\u4f8b -> instance level Operator # \u662f\u63cf\u8ff0\u3001\u90e8\u7f72\u548c\u7ba1\u7406kubernetes\u5e94\u7528\u7684\u4e00 \u5957\u673a\u5236\uff0c\u4ece\u5b9e\u73b0\u4e0a\u6765\u8bf4\uff0c\u53ef\u4ee5\u5c06\u5176\u7406\u89e3\u4e3a CRD \u914d\u5408\u53ef\u9009\u7684 webhook \u4e0e controller \u6765 \u5b9e\u73b0\u7528\u6237\u4e1a\u52a1\u903b\u8f91 Operator=CRD+Webhook+Controller \u901a\u5e38\u4ee5Pod\u65b9\u5f0f\u90e8\u7f72 \u5e38\u89c1\u5e94\u7528\u573a\u666f \u6309\u9700\u90e8\u7f72\u5e94\u7528 \u5e94\u7528\u7684\u5b89\u88c5\u5347\u7ea7 \u5de5\u4f5c\u673a\u5236:\u5229\u7528\u4e86Kubernetes\u7684\u81ea\u5b9a\u4e49 API \u8d44\u6e90(CRD)\uff0c\u6765\u63cf\u8ff0\u6211\u4eec\u60f3\u8981\u90e8\u7f72\u7684 \u201c\u5e94\u7528\u201d;\u7136\u540e\u5728\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u91cc\uff0c\u6839\u636e\u81ea \u5b9a\u4e49 API \u5bf9\u8c61\u7684\u53d8\u5316\uff0c\u6765\u5b8c\u6210\u5177\u4f53\u7684\u90e8\u7f72\u548c \u8fd0\u7ef4\u5de5\u4f5c \u4f8b\u5b50:IstioOperator # WebexCdpOperator? Operator (custom controller)\u5f00\u53d1\u6846\u67b6 # kubebuilder https://github.com/kubernetes-sigs/kubebuilder Operator SDK https://github.com/operator-framework/operator-sdk \u5229\u7528 kubebuilder \u5b9e\u73b0Kubernetes\u5f00\u53d1 # \u521d\u59cb\u5316\uff0c\u751f\u6210\u4ee3\u7801\u6846\u67b6 \u521b\u5efaAPI\uff0c\u751f\u6210controller \u6846\u67b6 \u5b9a\u4e49CRD\uff0c\u5e76\u7f16\u8bd1 \u751f\u6210 webhook \u4ee3\u7801 \u5b9e\u73b0 controller \u4e1a\u52a1\u903b\u8f91 https://book-v1.book.kubebuilder.io/getting_started/installation_and_setup.html kubebuilder\u6f14\u793a # \u811a\u624b\u67b6\u521d\u59cb\u5316\uff1a kubebuilder init --domain nick.io --repo nick.io/demos \u521b\u5efa\uff1a kubebuilder create api --group app --version v1 --kind WebexNick Golang\u5b9e\u73b0\u5404\u4e2a\u63a5\u53e3 TODO: \u5b66\u4e60\u6e90\u7801\uff0c\u5199\u4e2a\u5c0f\u4f8b\u5b50\uff0c\u8bbe\u8ba1Cdp\u8d44\u6e90 Kubernetes \u7f16\u7a0b\u8303\u5f0f\u603b\u7ed3 # \u58f0\u660e\u5f0f API Controller CRD Operator Kubernetes \u8c03\u5ea6\u4e0e\u8d44\u6e90\u7ba1\u7406 # Kubernetes \u8d44\u6e90\u6a21\u578b # \u6240\u6709\u8ddf\u8c03\u5ea6\u548c\u8d44\u6e90\u7ba1\u7406\u76f8\u5173\u7684\u5c5e\u6027\u90fd\u5e94\u8be5\u662f\u5c5e\u4e8e Pod \u7ea7\u522b \u8d44\u6e90\u7c7b\u578b:CPU \u548c\u5185\u5b58\u914d\u7f6e Pod\u6574\u4f53\u8d44\u6e90 = \u6240\u6709\u5bb9\u5668\u8d44\u6e90\u548c \u8d44\u6e90\u8bbe\u7f6e \u2013 request\u548climit # requests \u548c limits kube-scheduler\u53ea\u4f1a\u6309\u7167requests\u7684\u503c\u8c03\u5ea6\u3002 \u8bbe\u7f6eCgroups\u9650\u5236(Cgroups\u9650\u5236\u5bb9\u5668\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5)\u7684\u65f6\u5019\uff0ckubelet\u5219\u4f1a\u6309\u7167 limits \u7684\u503c \u5355\u4f4d:CPU\u4e2a\u6570;Mi/Gi...;M/G... \u52a8\u6001\u8d44\u6e90\u8fb9\u754c \u5efa\u8bae\uff1a\u4e00\u5b9a\u5728\u5bb9\u5668\u7684\u8d44\u6e90\u8bbe\u7f6e\u4e2d\u52a0\u4e0a requests \u548c limits \u7ecf\u9a8c\uff1a requests \u8bbe\u7f6e\u4fdd\u8bc1\u670d\u52a1\u80fd\u542f\u52a8\u5c31\u884c Pod\u7684\u670d\u52a1\u8d28\u91cf(QoS) # Guaranteed: Pod\u4e2d\u7684\u6bcf\u4e2a\u5bb9\u5668(\u5305\u542b\u521d\u59cb\u5316\u5bb9\u5668)\u5fc5\u987b\u6307\u5b9arequest\u548climit CPU\u548c\u5185\u5b58\u90fd\u8981\u8bbe\u7f6e Request=limit Burstable Pod\u4e0d\u6ee1\u8db3Guaranteed\u7684\u6761\u4ef6 \u4f46\u81f3\u5c11\u6709\u4e00\u4e2aContainer\u8bbe\u7f6e\u4e86requests BestEffort: Pod\u65e2\u6ca1\u6709\u8bbe\u7f6erequests\uff0c\u4e5f\u6ca1\u6709\u8bbe\u7f6elimits \u8d44\u6e90\u56de\u6536(Eviction) # Eviction:\u5bbf\u4e3b\u673a\u8d44\u6e90\u7d27\u5f20\u65f6\u56de\u6536Pod \u89e6\u53d1\u6761\u4ef6:\u5185\u5b58\u3001\u78c1\u76d8\u7b49 2\u79cd\u6a21\u5f0f Soft:\u4f18\u96c5\u56de\u6536 Hard:\u7acb\u523b\u56de\u6536 \u56de\u6536\u7b56\u7565 \u6839\u636eQoS\u7c7b\u522b \u540c\u7c7b\u522b\u6839\u636e\u4f18\u5148\u7ea7 Guaranteed\u8d85\u8fc7limit\u624d\u8003\u8651\u56de\u6536 cpuset\u8bbe\u7f6e Guaranteed\u7c7b\u578b\uff0crequest=limit\uff0c>=1\u7684\u6574\u6570 \u8c03\u5ea6\u5668kube-scheduler # \u804c\u8d23:Pod -> Node \u57fa\u672c\u6d41\u7a0b \u68c0\u67e5\u5e76\u6311\u9009Node \u6839\u636e\u9002\u914d\u5ea6\u6253\u5206 \u8c03\u5ea6:\u8bbe\u7f6e spec.nodeName \u8c03\u5ea6\u5668\u5de5\u4f5c\u539f\u7406 # 2\u4e2a\u63a7\u5236\u5faa\u73af informer path watch Priority Queue Cache scheduling path \u51fa\u961f \u8fc7\u6ee4 \u6253\u5206 \u7ed1\u5b9a \u7ed1\u5b9a(Bind) # Assume \u53ea\u66f4\u65b0cache\u7684pod\u3001node\u4fe1\u606f \u907f\u514d\u8fdc\u7a0b\u8bbf\u95eeapiserver Admit kubelet\u505a\u4e8c\u6b21\u786e\u8ba4 \u786e\u8ba4pod\u53ef\u4ee5\u8fd0\u884c\u5728\u88ab\u8c03\u5ea6\u7684node\u4e0a \u8c03\u5ea6\u7684\u6027\u80fd\u4f18\u5316\u8bbe\u8ba1 # \u8c03\u5ea6\u5668\u76843\u4e2a\u6027\u80fd\u4f18\u5316 cache\u5316 \u4e50\u89c2\u7ed1\u5b9a(\u5f02\u6b65bind) \u65e0\u9501\u5316 \u542f\u52a8\u591a\u4e2aGoroutine\u4ee5node\u4e3a\u7c92\u5ea6\u5e76\u53d1\u6267\u884cPredicates\u7b97\u6cd5\uff0c\u63d0\u9ad8\u6267\u884c\u6548\u7387 Priorities\u7b97\u6cd5\u4ee5MapReduce\u7684\u65b9\u5f0f\u5e76\u884c\u8ba1\u7b97\u518d\u8fdb\u884c\u6c47\u603b \u907f\u514d\u8bbe\u7f6e\u4efb\u4f55\u5168\u5c40\u7684\u7ade\u4e89\u8d44\u6e90 \u8c03\u5ea6\u5668\u53ea\u6709\u5bf9\u8c03\u5ea6\u961f\u5217\u548cSchedulerCache\u8fdb\u884c\u64cd\u4f5c\u65f6\uff0c\u624d\u9700\u8981\u52a0\u9501 \u8c03\u5ea6\u7684\u53ef\u6269\u5c55\u6027 # Scheduling Cycle * Sort, (then pick a pod from scheduling queue) * PreFilter * Filter * PreScore * Score * Normalize Score * Reserve (reserve a node for the pod in cache) * Permit Binding Cycle * WaitOnPermit (internal api) * PreBind * Bind (Bind pod to node) * PostBind \u8c03\u5ea6\u7b56\u7565 - predicate # \u672c\u8d28:\u4e00\u7cfb\u5217\u8fc7\u6ee4\u5668(filter) \u529f\u80fd:\u6309\u7167\u8c03\u5ea6\u7b56\u7565\uff0c\u4ece\u6240\u6709\u8282\u70b9\u4e2d\u8fc7\u6ee4\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8282\u70b9 3\u79cd\u7c7b\u578b GeneralPredicates Volume\u76f8\u5173 \u5bbf\u4e3b\u673a\u76f8\u5173 https://kubernetes.io/docs/reference/scheduling/policies/ \u57fa\u7840\u7b56\u7565 - GeneralPredicates # \u8d1f\u8d23\u7684\u662f\u6700\u57fa\u7840\u7684\u8c03\u5ea6\u7b56\u7565 \u5e38\u89c1\u7b56\u7565\u4e3e\u4f8b PodFitsResources \u8ba1\u7b97\u7684\u5c31\u662f\u5bbf\u4e3b\u673a\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\u7b49\u662f\u5426\u591f\u7528(\u53ea\u68c0\u67e5request) external resource:\u5176\u4ed6\u975e\u6807\u51c6\u8d44\u6e90\u5982gpu\u7528key-value\u65b9\u5f0f\u5b9a\u4e49 PodFitsHost :host = Pod \u7684 spec.nodeName(pod\u8bbe\u7f6e\u4e86) PodFitsHostPorts:Pod \u7533\u8bf7\u7684\u5bbf\u4e3b\u673a\u7aef\u53e3(spec.nodePort)\u662f\u5426\u88ab\u5360\u7528 PodMatchNodeSelector :Pod \u7684 nodeSelector \u6216\u8005 nodeAffinity \u8282\u70b9\uff0c\u662f\u5426\u4e0e\u5f85\u8003\u5bdf\u8282\u70b9\u5339\u914d Volume \u7b56\u7565 # \u5bb9\u5668\u6301\u4e45\u5316 Volume \u76f8\u5173 \u5e38\u89c1\u7b56\u7565 NoDiskConflict:\u591a\u4e2a Pod \u58f0\u660e\u6302\u8f7d\u7684\u6301\u4e45\u5316 Volume \u662f\u5426\u6709\u51b2\u7a81\u3002 NoVolumeZoneConflict:\u5b58\u50a8\u7684\u6545\u969c\u533a\u57df\u9650\u5236 CheckVolumeBinding:\u6839\u636ePod\u8bf7\u6c42\u7684\u5bb9\u91cf\u548cPVC\u662f\u5426\u5339\u914d LPV \u5fc5\u987b\u4f7f\u7528 nodeAffinity \u8ddf\u67d0\u4e2a\u8282\u70b9\u7ed1\u5b9a \u5bbf\u4e3b\u673a\u76f8\u5173\u7b56\u7565 # \u4e3b\u8981\u8003\u5bdf\u5f85\u8c03\u5ea6 Pod \u662f\u5426\u6ee1\u8db3 Node \u672c\u8eab\u7684\u67d0\u4e9b\u6761\u4ef6 PodToleratesNodeTaints:\u6c61\u70b9\u68c0\u67e5 Predicate \u7b56\u7565\u603b\u7ed3 # \u5f00\u59cb\u8c03\u5ea6\u4e00\u4e2aPod\u65f6\uff0c\u8c03\u5ea6\u5668\u4f1a\u540c\u65f6\u542f\u52a8 16 \u4e2a Goroutine\u6765\u5e76\u53d1\u5730\u4e3a\u96c6\u7fa4\u91cc\u7684\u6240\u6709 Node \u8ba1\u7b97 Predicates\uff0c\u6700\u540e\u8fd4\u56de\u53ef\u4ee5\u8fd0\u884c\u8fd9\u4e2a Pod \u7684\u5bbf\u4e3b\u673a\u5217\u8868\u3002 \u5728\u4e3a\u6bcf\u4e2aNode\u6267\u884cPredicates\u65f6\uff0c\u8c03\u5ea6 \u5668\u4f1a\u6309\u7167\u56fa\u5b9a\u7684\u987a\u5e8f\u6765\u8fdb\u884c\u68c0\u67e5\u3002 \u8c03\u5ea6\u7b56\u7565 - priority # \u529f\u80fd:\u6253\u5206\uff0c\u5f97\u5206\u6700\u9ad8\u5373\u4e3a\u6240\u9009Node \u5e38\u7528\u89c4\u5219: LeastRequestedPriority:\u9009\u62e9\u7a7a\u95f2\u8d44\u6e90\u6700\u591a\u7684\u5bbf\u4e3b\u673a BalancedResourceAllocation:\u8ba1\u7b97\u6bcf\u4e24\u79cd\u8d44\u6e90 Fraction \u4e4b\u95f4\u7684\u201c\u8ddd\u79bb\u201d ImageLocalityPriority:\u8282\u70b9\u4e0a\u6709\u9700\u8981\u7684\u955c\u50cf\uff0c\u5f97\u5206\u8d8a\u9ad8 NodeAffinityPriority:\u8282\u70b9\u4eb2\u548c\u89c4\u5219\uff0c\u6ee1\u8db3\u5b57\u6bb5\u8d8a\u591a\uff0c\u5f97\u5206\u8d8a\u9ad8 \u4ecepredicate\u5230 priority\u7684\u5b8c\u6574\u6d41\u7a0b # \u8c03\u5ea6\u4f18\u5148\u7ea7 # \u4f18\u5148\u7ea7\u548c\u62a2\u5360\u662f\u8c03\u5ea6\u5668\u53e6\u4e00\u4e2a\u91cd\u8981\u7279\u6027 \u89e3\u51b3\u95ee\u9898\u7684\u662fPod\u8c03\u5ea6\u5931\u8d25\u540e\u7684\u5982\u4f55\u5904\u7406 \u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2aPod\u8c03\u5ea6\u5931\u8d25\u540e\u4f1a\u88ab\u6682\u65f6\u6302\u8d77\uff0c\u76f4\u5230Pod\u66f4\u65b0\u6216\u96c6\u7fa4\u72b6\u6001\u53d8\u5316\u540e\u518d\u91cd\u65b0\u8c03 \u5ea6 \u4f18\u5148\u7ea7\u7684\u76ee\u7684:\u9ad8\u4f18\u5148\u7ea7\u7684Pod\u8c03\u5ea6\u5931\u8d25\u540e\u6324\u8d70\u4f4e\u4f18\u5148\u7ea7\u7684Pod PreemptionPolicy PreemptLowerPriority Never \u62a2\u5360\u673a\u5236\uff08Preemption\uff09 # \u4e00\u4e2a\u9ad8\u4f18\u5148\u7ea7\u7684 Pod (\u62a2\u5360\u8005)\u8c03\u5ea6\u5931\u8d25\uff0c\u8c03\u5ea6\u5668\u7684\u62a2\u5360\u80fd\u529b\u88ab\u89e6\u53d1\u3002 \u8c03\u5ea6\u5668\u4f1a\u8bd5\u56fe\u4ece\u5f53\u524d\u96c6\u7fa4\u91cc\u5bfb\u627e\u4e00\u4e2a\u8282\u70b9\uff0c\u5220\u9664\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u4f4e\u4f18\u5148\u7ea7 Pod \u9ad8\u4f18\u5148\u7ea7 Pod \u5c31\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a \u62a2\u5360\u53d1\u751f\u65f6\uff0c\u62a2\u5360\u8005\u4e0d\u4f1a\u7acb\u523b\u88ab\u8c03\u5ea6\u5230Node \u4e0a\u3002 \u8c03\u5ea6\u5668\u53ea\u4f1a\u5c06\u62a2\u5360\u8005\u7684 spec.nominatedNodeName \u5b57\u6bb5\u8bbe\u7f6e\u4e3a\u88ab\u62a2\u5360\u7684 Node \u7684\u540d\u5b57 \u62a2\u5360\u8005\u4f1a\u91cd\u65b0\u8fdb\u5165\u4e0b\u4e00\u4e2a\u8c03\u5ea6\u5468\u671f \u53ef\u80fd\u4f1a\u88ab\u66f4\u9ad8\u7ea7\u522b\u7684\u62a2\u5360\u8005\u63d2\u961f \u62a2\u5360\u673a\u5236\u539f\u7406 # \u9ad8\u4f18\u5148\u7ea7\u6324\u8d70\u4f4e\u4f18\u5148\u7ea7 \u6838\u5fc3\u5b9e\u73b0:2\u4e2a\u961f\u5217 activeQ unschedulableQ \u6d41\u7a0b \u68c0\u67e5\u5931\u8d25\u539f\u56e0 \u6a21\u62df\u62a2\u5360 \u6267\u884c\u62a2\u5360 \u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027 # \u6269\u5c55\u4e86\u4f60\u53ef\u4ee5\u8868\u8fbe\u7ea6\u675f\u7684\u7c7b\u578b 2\u79cd Node\u8282\u70b9\u4eb2\u548c\u6027 pod \u95f4\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027 \u8282\u70b9\u4eb2\u548c\u6027 # affinity.nodeAffinity \u8282\u70b9\u4eb2\u548c\u6027 \u914d\u7f6e \u786c\u9700\u6c42 requiredDuringSchedulingIgnoredDuringExecution \u8f6f\u9700\u6c42 preferredDuringSchedulingIgnoredDuringExecution \u524d\u8005\u6307\u5b9a\u4e86\u5c06 Pod \u8c03\u5ea6\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a \u5fc5\u987b\u6ee1\u8db3\u7684\u89c4\u5219 \u540e\u8005\u6307\u5b9a\u8c03\u5ea6\u5668\u5c06\u5c1d\u8bd5\u6267\u884c\u4f46\u4e0d\u80fd\u4fdd\u8bc1 Pod\u4eb2\u548c\u6027 # \u57fa\u4e8e\u5df2\u7ecf\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Pod\u7684\u6807\u7b7e\u6765\u7ea6\u675fPod\u53ef\u4ee5\u8c03\u5ea6\u5230\u7684\u8282\u70b9\uff0c\u800c\u4e0d\u662f\u57fa\u4e8e\u8282\u70b9\u7684\u6807\u7b7e \u89c4\u5219\u683c\u5f0f:\u201c\u5982\u679cX\u8282\u70b9\u4e0a\u5df2\u7ecf\u8fd0\u884c\u4e86\u4e00\u4e2a\u6216\u591a\u4e2a\u6ee1\u8db3\u89c4\u5219Y\u7684Pod\uff0c\u5219\u5f53\u524dPod\u5e94\u8be5(\u6216\u8005\u4e0d\u5e94\u8be5)\u8fd0\u884c\u5728 X \u8282\u70b9\u201d Pod\u95f4\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027\u9700\u8981\u5927\u91cf\u7684\u5904\u7406\uff0c \u53ef\u80fd\u4f1a\u51cf\u6162\u5927\u89c4\u6a21\u96c6\u7fa4\u4e2d\u7684\u8c03\u5ea6 \u914d\u7f6e: requiredDuringSchedulingIgnoredDuringExecution preferredDuringSchedulingIgnoredDuringExecution Pod\u95f4\u4eb2\u548c\u6027\u901a\u8fc7PodSpec\u4e2d affinity \u5b57\u6bb5\u4e0b\u7684 podAffinity \u5b57\u6bb5\u8fdb\u884c\u6307\u5b9a Pod\u95f4\u53cd\u4eb2\u548c\u6027\u901a\u8fc7PodSpec\u4e2d affinity \u5b57\u6bb5\u4e0b\u7684 podAntiAffinity \u5b57\u6bb5\u8fdb\u884c\u6307\u5b9a \u6c61\u70b9\u548c\u5bb9\u5fcd\u5ea6 # Taint(\u6c61\u70b9):\u4f7f\u8282\u70b9\u80fd\u591f\u6392\u65a5\u4e00\u7c7b\u7279\u5b9a\u7684Pod \u5bb9\u5fcd\u5ea6(Tolerations):\u5141\u8bb8Pod\u8c03\u5ea6\u5230\u5e26\u6709\u4e0e\u4e4b\u5339\u914d\u7684\u6c61\u70b9\u7684\u8282\u70b9\u4e0a Node\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u6c61\u70b9 Pod\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u5bb9\u5fcd\u5ea6 \u64cd\u4f5c\u7b26operator Exists Equals effect NoSchedule PreferNoSchedule NoExecute \u5e94\u7528\u573a\u666f \u4e13\u7528\u8282\u70b9 \u7279\u6b8a\u786c\u4ef6\u7684\u8282\u70b9 \u57fa\u4e8e\u6c61\u70b9\u7684\u9a71\u9010 \u6bd4\u5982\u8282\u70b9\u5347\u7ea7\uff1a\u5148\u6253\u6c61\u70b9\u5c06pod\u9a71\u9010\uff0c\u518d\u5347\u7ea7\u8282\u70b9 \u8d44\u6e90\u7684\u8bf7\u6c42\u548c\u9650\u5236 - LimitRange # \u5728namespace\u8303\u56f4\u5185\uff0c\u9650\u5236pod\u6216container\u8d44\u6e90\u4f7f\u7528\u91cf\u7684\u7b56\u7565 \u4f5c\u7528 \u9650\u5236namespace\u4e2d\u6bcf\u4e2apod\u6216container\u7684\u6700\u5c0f\u548c\u6700\u5927\u8d44\u6e90\u7528\u91cf\u3002 \u9650\u5236namespace\u4e2d\u6bcf\u4e2aPVC\u7684\u8d44\u6e90\u8bf7\u6c42\u8303\u56f4\u3002 \u9650\u5236namespace\u4e2d\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u6570\u91cf\u7684\u6bd4\u4f8b\u3002 \u914d\u7f6e\u8d44\u6e90\u7684\u9ed8\u8ba4\u9650\u5236 \u8d44\u6e90\u7c7b\u578b Pod Container PVC \u63a7\u5236\u9650\u5236\u91cf\u548c\u8bf7\u6c42\u91cf\u7684\u6700\u5927\u6bd4\u4f8b\uff0c\u5373limit/request\u8981\u6c42\u5c0f\u4e8e\u7b49\u4e8e maxLimitRequestRatio \u9650\u5236\u793a\u4f8b # \u914d\u7f6e\u89c4\u5219 Request\u3001limit\u90fd\u6709 \u6ca1request\uff0c\u6309limit \u6ca1limit\uff0c\u6309\u9ed8\u8ba4 \u53ea\u5728Pod\u521b\u5efa\u548c\u66f4\u65b0\u65f6\u624d\u5f3a\u5236\u6267\u884c \u66f4\u65b0LimitRange\u4e0d\u4f1a\u5f71\u54cd\u6b64\u524d\u521b\u5efa\u7684Pod \u5e94\u7528\u573a\u666f \u547d\u540d\u7a7a\u95f4\u6709\u914d\u989d\u9650\u5236 \u8d44\u6e90\u603b\u548c\u4e0d\u80fd\u8d85\u8fc7\u8bbe\u5b9a\u503c \u8d44\u6e90\u914d\u989d - ResouceQutoa # \u5b9e\u73b0\u8d44\u6e90\u6d88\u8017\u603b\u91cf\u7684\u9650\u5236 \u4e24\u4e2a\u4f5c\u7528 \u6309\u7c7b\u578b\u9650\u5236\u547d\u540d\u7a7a\u95f4\u4e0b\u6240\u521b\u5efa\u5bf9\u8c61\u7684\u6570\u91cf \u9650\u5236\u6240\u6d88\u8017\u8ba1\u7b97\u8d44\u6e90\u7684\u603b\u91cf \u8ba1\u7b97\u8d44\u6e90\u914d\u989d \u5b58\u50a8\u914d\u989d \u5bf9\u8c61\u6570\u91cf\u914d\u989d \u8c03\u5ea6\u5668\u5c0f\u7ed3 # \u8c03\u5ea6\u5668\u5de5\u4f5c\u539f\u7406 \u8c03\u5ea6\u7b97\u6cd5\u3001\u7b56\u7565 \u4eb2\u548c\u6027 \u6c61\u70b9\u3001\u5bb9\u5fcd\u5ea6 \u8d44\u6e90\u9650\u5236 Kubernetes \u672a\u6765\u5c55\u671b # https://www.eficode.com/blog/the-future-of-kubernetes-and-why-developers-should-look-beyond-kubernetes-in-2022 \u5b89\u5168\uff1aOIDC vs Secret Secret\u5bf9\u8c61\u8fd8\u662f\u6709\u53ef\u80fd\u4f1a\u88ab\u4fdd\u5b58\u5728pipeline\u4e2d https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#openid-connect-tokens https://kubernetes.io/docs/reference/kubernetes-api/config-and-storage-resources/secret-v1/ \u7f51\u7edc\uff1aGateway API vs Ingress Ingress\u7684\u80fd\u529b\u88ab\u8ba4\u4e3a\u6bd4\u8f83\u5f31\uff0cIngress\u5728service mesh\u91cc\u662f\u4e2a\u9e21\u808b Gateway API https://kubernetes.io/zh-cn/blog/2022/07/13/gateway-api-graduates-to-beta/ https://kubernetes.io/docs/concepts/services-networking/ingress/ \u81ea\u52a8\u6269\u5c55\uff08\u6c34\u5e73\u4f38\u7f29\uff09\uff1aHPA / CA / KEDA HPA\u662f\u57fa\u4e8epod\u5c42\u9762\u7684\u6c34\u5e73\u4f38\u7f29 CA cluster-autoscaling \u662f\u5728node\u5c42\u9762\u7684\u6c34\u5e73\u4f38\u7f29 KEDA\u8ba4\u4e3a\u81ea\u52a8\u6269\u5c55\u4e0d\u4ec5\u4ec5\u662f\u57fa\u4e8e\u8d44\u6e90\u7684\u6269\u5c55\uff0c\u4e5f\u5e94\u8be5\u57fa\u4e8e\u4e8b\u4ef6\u6765\u81ea\u52a8\u6269\u5c55 https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/ https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler https://keda.sh/ \u5b58\u50a8\uff1aPV vs \u5bf9\u8c61\u5b58\u50a8 PV\u4e0d\u662f\u5f88\u597d\u7684practice\uff0c\u6709PV\u610f\u5473\u7740\u5bf9\u5b58\u50a8\u6709\u4f9d\u8d56\uff0c\u5e94\u5c3d\u53ef\u80fd\u57fa\u4e8e\u5bf9\u8c61\u5b58\u50a8 Kubernetes\u672a\u6765\uff1a\u57fa\u4e8eCRD\u7684\u62bd\u8c61\u5e73\u53f0 custom resource definition Kubernetes\u63d0\u4f9b\u4e86CRD\u7684\u6269\u5c55","title":"Kubernetes \u57fa\u7840\u8bfe (2022-11-24)"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes-2022-11-24","text":"Training of Cloud-Native Kubernetes for Development. \u5185\u5bb9\u63d0\u8981 Kubernetes \u5b58\u50a8 Kubernetes \u7f16\u7a0b(Controller\u3001Operator\u3001CRD) Kubernetes \u8c03\u5ea6\u4e0e\u8d44\u6e90\u7ba1\u7406 Kubernetes \u672a\u6765\u5c55\u671b","title":"Kubernetes \u57fa\u7840\u8bfe (2022-11-24)"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes","text":"","title":"Kubernetes \u5b58\u50a8"},{"location":"my-kubernetes/k8s-lesson-20221124/#_1","text":"\u6709\u72b6\u6001\u5e94\u7528\u7684\u5b58\u50a8\u62d3\u6251 \u65e0\u72b6\u6001\u5e94\u7528\u4e0e\u5b58\u50a8\u5206\u79bb","title":"\u6709\u72b6\u6001\u5e94\u7528\u7684\u5b58\u50a8\u72b6\u6001"},{"location":"my-kubernetes/k8s-lesson-20221124/#1","text":"\u5377(Volume):\u5c06\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee \u5f55\uff0c\u8ddf\u4e00\u4e2a\u5bb9\u5668\u91cc\u7684\u76ee\u5f55\u7ed1\u5b9a\u6302\u8f7d \u5728\u4e86\u4e00\u8d77\u3002 \u4f7f\u7528volumeMounts\u6302\u8f7d:\u58f0\u660e\u5377\u5728 \u5bb9\u5668\u4e2d\u7684\u6302\u8f7d\u4f4d\u7f6e \u672c\u5730\u5b58\u50a8\u5e38\u7528\u7c7b\u578b emptyDir hostPath","title":"1. \u5bb9\u5668\u6570\u636e\u7684\u672c\u5730(\u4e34\u65f6)\u5b58\u50a8"},{"location":"my-kubernetes/k8s-lesson-20221124/#-emptydir","text":"\u4e0e Pod \u540c\u751f\u547d\u5468\u671f \u521d\u59cb\u5316\u540e\u4e3a\u7a7a \u7528\u9014 \u7f13\u5b58\u7a7a\u95f4 \u4e34\u65f6\u5b58\u50a8 Web server\u4fdd\u5b58\u6587\u4ef6 apiVersion: v1 kind: Pod metadata: name: temp-volume-pod spec: containers: - image: nginx name: nginx volumeMounts: - mountPath: /cache-volume name: cache-volume - mountPath: /test-hostpath name: test-volume volumes: - name: cache-volume emptyDir: {} - name: test-volume hostPath: path: /etc # \u5bbf\u4e3b\u4e0a\u76ee\u5f55\u4f4d\u7f6e type: Directory # \u53ef\u9009","title":"\u672c\u5730\u5b58\u50a8 - emptyDir"},{"location":"my-kubernetes/k8s-lesson-20221124/#-hostpath","text":"\u5c06\u5bbf\u4e3b\u673a\u76ee\u5f55\u6302\u8f7d\u5230Pod \u7528\u9014 \u9700\u8981\u8bbf\u95eeDocker\u5185\u90e8\u6587\u4ef6(/var/lib/docker) \u5728\u5bb9\u5668\u4e2d\u8fd0\u884ccAdvisor\u65f6\uff0c\u6302\u8f7d/sys\u3002 \u83b7\u53d6hostPath\u7684\u6570\u636e\u4f5c\u4e3aPod\u521b\u5efa\u7684\u524d\u7f6e\u6761\u4ef6 type\u7c7b\u578b DirectoryOrCreate Directory FileOrCreate File ...... \u5c3d\u91cf\u907f\u514d\u4f7f\u7528hostPat\uff0c\u6709\u98ce\u9669 \u6709\u9650\u4f7f\u7528 readonly\u6302\u8f7d","title":"\u672c\u5730\u5b58\u50a8 - hostPath"},{"location":"my-kubernetes/k8s-lesson-20221124/#2","text":"\u672c\u5730\u4e34\u65f6\u5377\u7684\u7f3a\u70b9 \u4e0d\u80fd\u6301\u4e45\u5316;\u4e0d\u80fd\u5171\u4eab;\u4e0d\u80fd\u8fc1\u79fb \u6301\u4e45\u5316\u5377(Persistent Volume) \u72ec\u7acb\u4e8ePod\u751f\u547d\u5468\u671f \u89e3\u8026\u65e0\u72b6\u6001\u7684\u5e94\u7528\u548c\u6709\u72b6\u6001\u7684\u5b58\u50a8 \u57fa\u4e8e\u4e13\u95e8\u7684\u3001\u8fdc\u7a0b\u5b58\u50a8\u670d\u52a1 \u652f\u6301\u7c7b\u578b: \u4e91\u5e73\u53f0\u5b58\u50a8:AWS EBS\u3001AzureDisk\u7b49 CephFS\u3001CSI\u3001NFS\u7b49\u7b49 types-of-persistent-volumes","title":"2. \u5bb9\u5668\u6570\u636e\u7684\u6301\u4e45\u5316\u5b58\u50a8"},{"location":"my-kubernetes/k8s-lesson-20221124/#pv-pvc","text":"PV(Persistentvolume) \u6301\u4e45\u5316\u5377 \u5b9a\u4e49\u4e00\u4e2a\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\u6216\u8fdc\u7aef PVC(Persistent volume claim) \u63cf\u8ff0Pod\u60f3\u4f7f\u7528\u7684\u5b58\u50a8\u76f8\u5173\u7684\u5c5e\u6027 \u5173\u7cfb\uff1a\u7c7b\u4f3c\u62bd\u8c61\u4e0e\u7ee7\u627f \u4e3a\u4ec0\u4e48\u8981\u8bbe\u8ba1PV\u3001PVC\uff1f \u7ba1\u7406\u5458\u5f00\u53d1PV\uff0c\u63d0\u4f9b\u63a5\u53e3 \u5f00\u53d1\u4eba\u5458\u5f00\u53d1PV\uff0c\u53ea\u9700\u8981\u5173\u5fc3\u4f7f\u7528\u7684\u6301\u4e45\u5316\u5b58\u50a8\u5c5e\u6027","title":"PV \u548c PVC"},{"location":"my-kubernetes/k8s-lesson-20221124/#pvpersistent-volume","text":"\u6838\u5fc3\u5b57\u6bb5 capacity volumeMode accessMode persistentVolumeReclaimPolicy storageClassName mountOptions \u9636\u6bb5(phase) Available(\u53ef\u7528) Bound(\u5df2\u7ed1\u5b9a) Released(\u5df2\u91ca\u653e) Failed(\u5931\u8d25)","title":"PV(Persistent Volume)"},{"location":"my-kubernetes/k8s-lesson-20221124/#pvcpersistent-volume-claim","text":"\u63cf\u8ff0\u8981\u4f7f\u7528\u7684\u5b58\u50a8\u5c5e\u6027 \u65e0\u9700\u5173\u6ce8\u5b58\u50a8\u5b9e\u73b0 \u6838\u5fc3\u5b57\u6bb5 accessMode volumeMode resources storageClassName selector:matchLabels\u3001matchExpressions \u7ed1\u5b9a\u6761\u4ef6 spec \u5339\u914d StorageClassName \u4e00\u81f4","title":"PVC(Persistent Volume Claim)"},{"location":"my-kubernetes/k8s-lesson-20221124/#provisioning","text":"\u4e24\u4e2a\u9636\u6bb5 Attach\u9636\u6bb5 Mount\u9636\u6bb5 \u63a7\u5236\u5668 AttachDetachController -> kube-controller-manager VolumeManagerReconciler -> worker node","title":"\u7ed1\u5b9a(provisioning)\u5de5\u4f5c\u539f\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#_2","text":"\u7ba1\u7406\u5458\u9700\u8981\u624b\u52a8\u521b\u5efaPV\u3002\u96c6\u7fa4\u89c4\u6a21\u5927\u65f6\uff0c\u9700\u8981\u521b\u5efa\u4e00\u5927\u5806PV\uff0c\u7ef4\u62a4\u4e0d\u4fbf","title":"\u9759\u6001\u7ed1\u5b9a\u7684\u7f3a\u70b9"},{"location":"my-kubernetes/k8s-lesson-20221124/#dynamic-provisioning","text":"StorageClass \u521b\u5efaPV\u6a21\u677f","title":"\u52a8\u6001\u7ed1\u5b9a(Dynamic Provisioning)"},{"location":"my-kubernetes/k8s-lesson-20221124/#storageclass","text":"\u5b58\u50a8\u7c7b(StorageClass) \u521b\u5efaPV\u6a21\u677f(\u5bf9\u8c61) \u5c5e\u6027 \u5b58\u50a8\u63d2\u4ef6 \u5b57\u6bb5 Provisioner Parameter reclaimPolicy \u56de\u6536\u7b56\u7565","title":"\u4f7f\u7528 StorageClass \u52a8\u6001\u7ed1\u5b9a"},{"location":"my-kubernetes/k8s-lesson-20221124/#_3","text":"\u8981\u5220\u9664PV/PVC\uff0c\u5148\u5220\u4f7f\u7528\u8005(Pod) \u751f\u4ea7\u73af\u5883\u4e00\u822c\u90fd\u662f\u901a\u8fc7\u52a8\u6001\u7ed1\u5b9a\u7684\u65b9\u5f0f","title":"\u5176\u4ed6"},{"location":"my-kubernetes/k8s-lesson-20221124/#3","text":"Local Persistent Volume(LPV) \u672c\u5730\u5b58\u50a8\u9700\u6c42 (\u6027\u80fd) \u4e00\u822c\u662f\u989d\u5916\u78c1\u76d8\uff0c\u4e0d\u5e94\u4f7f\u7528\u672c\u5730\u78c1\u76d8 \u9650\u5236\uff1a \u4e0d\u652f\u6301\u52a8\u6001\u7ed1\u5b9a Node\u8c03\u5ea6\u95ee\u9898 \u8de8\u533a\u95ee\u9898 \u5fc5\u987b\u4f7f\u7528\u8282\u70b9\u4eb2\u548c\u6027nodeAffinity\u786e\u4fddpod\u88ab\u8c03\u5ea6\u5230\u5f53\u524dnode \u5ef6\u8fdf\u7ed1\u5b9a WaitForFirstConsumer \u7b49\u5f85Pod\u521b\u5efa \u7ed1\u5b9aPV\u548cPVC","title":"3. \u672c\u5730\u6301\u4e45\u5377"},{"location":"my-kubernetes/k8s-lesson-20221124/#lpv","text":"\u4f8b\u5982WaitForFirstConsumer \u4e3a\u4ec0\u4e48LPV\u8981\u6709\u5ef6\u8fdf\u7ed1\u5b9a\uff1f \u8c03\u5ea6\u5668\u8003\u8651\u5377\u5206\u5e03\u7684\u539f\u5219\uff0c\u9632\u6b62Pod\u88ab\u4eb2\u548c\u6027\u7ed1\u5b9a\u81f3\u4e0d\u540c\u7684node","title":"LPV\u7684\u5ef6\u8fdf\u7ed1\u5b9a"},{"location":"my-kubernetes/k8s-lesson-20221124/#-csi","text":"\u5bb9\u5668\u5b58\u50a8\u63a5\u53e3 \u7ec4\u4ef6 DriverRegistrar ExternalProvisioner ExternalAttacher CSI\u63d2\u4ef6\u670d\u52a1 Identity Controller Node \u9700\u8981\u5f00\u53d1\u81ea\u5b9a\u4e49\u5b58\u50a8\u63a5\u53e3\u65f6\uff0c\u53c2\u8003 https://github.com/container-storage-interface/spec","title":"\u5bb9\u5668\u5b58\u50a8\u63a5\u53e3 - CSI"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_1","text":"\u4e34\u65f6\u5377 \u6301\u4e45\u5316\u5377 \u9759\u6001\u3001\u52a8\u6001\u7ed1\u5b9a \u672c\u5730\u6301\u4e45\u5377 CSI\u63a5\u53e3","title":"Kubernetes \u5b58\u50a8\u5c0f\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_2","text":"","title":"Kubernetes \u7f16\u7a0b\u8303\u5f0f"},{"location":"my-kubernetes/k8s-lesson-20221124/#_4","text":"Programming paradigm\uff0c\u53c8\u53eb\u7f16\u7a0b\u8303\u578b\u3001\u7f16\u7a0b\u8303\u5f0f\u6216\u7a0b\u5e8f\u8bbe\u8ba1\u6cd5\uff0c\u662f\u6307\u8f6f \u4ef6\u5de5\u7a0b\u4e2d\u7684\u4e00\u7c7b\u5178\u578b\u7684\u7f16\u7a0b\u98ce\u683c\u3002 \u5206\u7c7b \u547d\u4ee4\u5f0f\u7f16\u7a0b \u9762\u5411\u8fc7\u7a0b\u7f16\u7a0b \u9762\u5411\u5bf9\u8c61\u7f16\u7a0b \u51fd\u6570\u5f0f\u7f16\u7a0b Kubernetes\u7684\u7f16\u7a0b\u8303\u5f0f/\u98ce\u683c?","title":"\u4ec0\u4e48\u662f\u7f16\u7a0b\u8303\u5f0f"},{"location":"my-kubernetes/k8s-lesson-20221124/#_5","text":"\u58f0\u660e\u5f0f\u7f16\u7a0b(Declarative programming)\u662f\u4e00\u79cd\u7f16\u7a0b\u8303\u5f0f\uff0c\u4e0e\u547d\u4ee4\u5f0f\u7f16\u7a0b\u76f8\u5bf9\u7acb\u3002 \u5b83\u63cf\u8ff0\u60f3\u8981\u8fbe\u5230\u7684\u76ee\u6807\u72b6\u6001\uff0c\u8ba9\u8ba1\u7b97\u673a(\u5de5\u5177)\u5185\u90e8\u81ea\u5df1\u5b9e\u73b0\u5982\u4f55\u8fbe\u5230\u76ee\u6807\u3002 \u800c\u547d\u4ee4\u5f0f\u7f16\u7a0b\u5219\u9700\u8981\u7528\u7b97\u6cd5\u6765\u660e\u786e\u7684\u6307\u51fa\u6bcf\u4e00\u6b65\u8be5\u600e\u4e48\u505a\u3002 \u547d\u4ee4\u5f0f(Imperative):\u544a\u8bc9\u7cfb\u7edf\u600e\u4e48\u505a(\u4e00\u7cfb\u5217\u52a8\u4f5c) \u58f0\u660e\u5f0f(Declarative):\u544a\u8bc9\u7cfb\u7edf\u8981\u4ec0\u4e48(\u76ee\u6807\u72b6\u6001)","title":"\u58f0\u660e\u5f0f\u7f16\u7a0b"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes-api","text":"create\u3001replace\u3001apply\uff0c\u54ea\u4e2a\u624d\u662f\u58f0\u660e\u5f0f? \u58f0\u660e\u5f0fAPI\u7684\u80fd\u529b:Patch Kubernetes \u7f16\u6392\u6838\u5fc3:\u58f0\u660e\u3001\u5b9a\u4e49\u3001\u8c03\u8c10(reconcile)","title":"Kubernetes \u91cc\u7684\u58f0\u660e\u5f0fAPI"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes-api_1","text":"\u64cd\u4f5cKubernetes\u5bf9\u8c61(CRUD)\u90fd\u9700\u8981\u4f7f\u7528KubernetesAPI \u6811\u5f62\u7ed3\u6784 \u8d44\u6e90\u8def\u5f84 Group Version Resource \u6838\u5fc3\u5bf9\u8c61\u6ca1\u6709Group Group\u901a\u8fc7\u529f\u80fd\u5212\u5206 \u652f\u6301\u591a\u7248\u672c API\u6269\u5c55 \u81ea\u5b9a\u4e49\u8d44\u6e90(CRD) \u805a\u5408\u5c42","title":"Kubernetes API\u5bf9\u8c61"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes-api_2","text":"\u89e3\u6790\u8fc7\u7a0b \u5339\u914d\u7ec4 \u5339\u914d\u7248\u672c \u5339\u914d\u8d44\u6e90\u7c7b\u578b \u5bf9\u8c61\u521b\u5efa\u8fc7\u7a0b \u53d1\u8d77\u521b\u5efa\u8bf7\u6c42 \u8fc7\u6ee4 \u7ed1\u5b9a\u5904\u7406\u5668(\u589e\u5220\u6539\u67e5\u5bf9\u5e94\u7684handler) \u627e\u5230\u5bf9\u8c61\u5b9a\u4e49 \u521b\u5efa\u8d44\u6e90 \u51c6\u5165\u3001\u9a8c\u8bc1 \u5e8f\u5217\u5316\u5b58\u50a8","title":"Kubernetes \u58f0\u660e\u5f0fAPI\u5de5\u4f5c\u539f\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#api","text":"Request -> API HTTP handler -> \u9274\u6743(authentication/authorization) -> \u53d8\u66f4\u51c6\u5165\u63a7\u5236\u5668 mutating admission controller <-> mutating admission webhooks -> object schema validation -> \u9a8c\u8bc1\u51c6\u5165\u63a7\u5236\u5668 validating admission controller <-> validating admission webhooks -> persisted to ETCD","title":"API \u8bf7\u6c42\u751f\u547d\u5468\u671f"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes-controller","text":"\u4e00\u4e2a\u63a7\u5236\u5668\u81f3\u5c11\u8ffd\u8e2a\u67d0\u79cd\u8d44\u6e90\uff0c\u8d1f\u8d23\u5c06\u8d44\u6e90\u7684\u5f53\u524d\u72b6\u6001\u4fee\u6539\u4e3a\u7528\u6237\u671f\u671b\u7684\u72b6\u6001 \uff08\u5373\u8c03\u534f\u8fc7\u7a0b\uff09 \u73b0\u5b9e\u6001 -> \u671f\u671b\u6001 \uff08\u9762\u5411\u7ec8\u6001\u7684\u8bbe\u8ba1\uff09 \u63a7\u5236\u5faa\u73af Control loop \u5185\u7f6e\u63a7\u5236\u5668 \u81ea\u5b9a\u4e49\u63a7\u5236\u5668","title":"Kubernetes \u7f16\u7a0b\u6838\u5fc3 - Controller"},{"location":"my-kubernetes/k8s-lesson-20221124/#_6","text":"\u5b9e\u73b0\u6d41\u7a0b * main\u51fd\u6570 * \u63a7\u5236\u5668\u7684\u5b9a\u4e49 * \u63a7\u5236\u5668\u4e1a\u52a1\u903b\u8f91 API Server -> Informer -> Work Queue -> Control Loop","title":"\u63a7\u5236\u5668\u5de5\u4f5c\u539f\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#informer","text":"\u5e26\u6709\u672c\u5730\u7f13\u5b58\u548c\u7d22\u5f15\u673a\u5236\u7684\u3001\u53ef\u4ee5\u6ce8\u518c EventHandler \u7684 client \u5b83\u662f\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u8ddfAPIServer\u8fdb\u884c\u6570\u636e\u540c\u6b65\u7684 \u91cd\u8981\u7ec4\u4ef6 \u901a\u8fc7ListAndWatch\u7684\u65b9\u6cd5\uff0c\u628aAPIServer\u4e2d\u7684 API\u5bf9\u8c61\u7f13\u5b58\u5728\u4e86\u672c\u5730\uff0c\u5e76\u8d1f\u8d23\u66f4\u65b0\u548c\u7ef4\u62a4\u8fd9\u4e2a \u7f13\u5b58 \u804c\u8d23\u4e00:\u83b7\u53d6\u5bf9\u8c61\u53d8\u5316\uff0c\u66f4\u65b0\u672c\u5730\u7f13\u5b58 \u804c\u8d23\u4e8c:\u6839\u636e\u4e8b\u4ef6\uff0c\u89e6\u53d1\u5bf9\u5e94\u7684\u5904\u7406\u5668","title":"Informer \u603b\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#controller","text":"\u8c03\u7528controller.Run()\u542f\u52a8\u201c\u63a7\u5236\u5faa\u73af\u201d \u7b49\u5f85Informer\u5b8c\u6210\u4e00\u6b21\u672c\u5730\u7f13\u5b58\u7684\u6570\u636e\u540c\u6b65\u64cd\u4f5c \u901a\u8fc7goroutine\u542f\u52a8\u4e00\u4e2a\u201c\u65e0\u9650\u5faa\u73af\u201d\u7684\u4efb\u52a1\u3002\u6bcf\u4e00\u4e2a\u5faa\u73af\u5468\u671f\uff0c\u6267\u884c\u4e1a\u52a1\u903b\u8f91 \u4e1a\u52a1\u903b\u8f91: \u51fa\u961f\u5217\uff0c\u62ff\u5230key\uff0c\u4eceinformer\u7f13\u5b58\u4e2d\u62ff\u5230\u5bf9\u8c61 \u5bf9\u6bd4\u201c\u671f\u671b\u72b6\u6001\u201d\u548c\u201c\u5b9e\u9645\u72b6\u6001\u201d\uff0c\u5b8c\u6210\u8c03\u8c10reconcile\u8fc7\u7a0b","title":"Controller \u603b\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_3","text":"Informer\uff0c\u5c31\u662f\u4e00\u4e2a\u81ea\u5e26\u7f13\u5b58\u548c\u7d22\u5f15\u673a\u5236\uff0c\u53ef\u4ee5\u89e6\u53d1Handler\u7684\u5ba2\u6237\u7aef\u5e93 \u4f7f\u7528Reflector\u5305\uff0c\u901a\u8fc7ListAndWatch\u673a\u5236\u83b7\u53d6\u5e76\u76d1\u89c6API\u5bf9\u8c61\u53d8\u5316 \u5165\u961f\u534f\u540c(Informer & reflector):DeltaFIFOQueue \u51fa\u961f\u534f\u540c(Informer & control loop):WorkQueue \u5b9e\u73b0\u671f\u671b\u72b6\u6001\u4e0e\u5b9e\u9645\u72b6\u6001\u7684\u8c03\u8c10(reconcile)","title":"Kubernetes \u7f16\u7a0b\u8303\u5f0f\u7684\u6838\u5fc3\u601d\u8def"},{"location":"my-kubernetes/k8s-lesson-20221124/#crd","text":"Why K8S\u73b0\u6709\u8d44\u6e90\u4e0d\u80fd\u6ee1\u8db3\u9700\u6c42 \u81ea\u5b9a\u4e49\u8d44\u6e90 - CR \u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49 - CRD \u81ea\u5b9a\u4e49\u63a7\u5236\u5668 CRD\u662f\u62bd\u8c61 -> schema level CR\u662f\u5b9e\u4f8b -> instance level","title":"\u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49(CRD)"},{"location":"my-kubernetes/k8s-lesson-20221124/#operator","text":"\u662f\u63cf\u8ff0\u3001\u90e8\u7f72\u548c\u7ba1\u7406kubernetes\u5e94\u7528\u7684\u4e00 \u5957\u673a\u5236\uff0c\u4ece\u5b9e\u73b0\u4e0a\u6765\u8bf4\uff0c\u53ef\u4ee5\u5c06\u5176\u7406\u89e3\u4e3a CRD \u914d\u5408\u53ef\u9009\u7684 webhook \u4e0e controller \u6765 \u5b9e\u73b0\u7528\u6237\u4e1a\u52a1\u903b\u8f91 Operator=CRD+Webhook+Controller \u901a\u5e38\u4ee5Pod\u65b9\u5f0f\u90e8\u7f72 \u5e38\u89c1\u5e94\u7528\u573a\u666f \u6309\u9700\u90e8\u7f72\u5e94\u7528 \u5e94\u7528\u7684\u5b89\u88c5\u5347\u7ea7 \u5de5\u4f5c\u673a\u5236:\u5229\u7528\u4e86Kubernetes\u7684\u81ea\u5b9a\u4e49 API \u8d44\u6e90(CRD)\uff0c\u6765\u63cf\u8ff0\u6211\u4eec\u60f3\u8981\u90e8\u7f72\u7684 \u201c\u5e94\u7528\u201d;\u7136\u540e\u5728\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u91cc\uff0c\u6839\u636e\u81ea \u5b9a\u4e49 API \u5bf9\u8c61\u7684\u53d8\u5316\uff0c\u6765\u5b8c\u6210\u5177\u4f53\u7684\u90e8\u7f72\u548c \u8fd0\u7ef4\u5de5\u4f5c","title":"Operator"},{"location":"my-kubernetes/k8s-lesson-20221124/#istiooperator","text":"WebexCdpOperator?","title":"\u4f8b\u5b50:IstioOperator"},{"location":"my-kubernetes/k8s-lesson-20221124/#operator-custom-controller","text":"kubebuilder https://github.com/kubernetes-sigs/kubebuilder Operator SDK https://github.com/operator-framework/operator-sdk","title":"Operator (custom controller)\u5f00\u53d1\u6846\u67b6"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubebuilder-kubernetes","text":"\u521d\u59cb\u5316\uff0c\u751f\u6210\u4ee3\u7801\u6846\u67b6 \u521b\u5efaAPI\uff0c\u751f\u6210controller \u6846\u67b6 \u5b9a\u4e49CRD\uff0c\u5e76\u7f16\u8bd1 \u751f\u6210 webhook \u4ee3\u7801 \u5b9e\u73b0 controller \u4e1a\u52a1\u903b\u8f91 https://book-v1.book.kubebuilder.io/getting_started/installation_and_setup.html","title":"\u5229\u7528 kubebuilder \u5b9e\u73b0Kubernetes\u5f00\u53d1"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubebuilder","text":"\u811a\u624b\u67b6\u521d\u59cb\u5316\uff1a kubebuilder init --domain nick.io --repo nick.io/demos \u521b\u5efa\uff1a kubebuilder create api --group app --version v1 --kind WebexNick Golang\u5b9e\u73b0\u5404\u4e2a\u63a5\u53e3 TODO: \u5b66\u4e60\u6e90\u7801\uff0c\u5199\u4e2a\u5c0f\u4f8b\u5b50\uff0c\u8bbe\u8ba1Cdp\u8d44\u6e90","title":"kubebuilder\u6f14\u793a"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_4","text":"\u58f0\u660e\u5f0f API Controller CRD Operator","title":"Kubernetes \u7f16\u7a0b\u8303\u5f0f\u603b\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_5","text":"","title":"Kubernetes \u8c03\u5ea6\u4e0e\u8d44\u6e90\u7ba1\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_6","text":"\u6240\u6709\u8ddf\u8c03\u5ea6\u548c\u8d44\u6e90\u7ba1\u7406\u76f8\u5173\u7684\u5c5e\u6027\u90fd\u5e94\u8be5\u662f\u5c5e\u4e8e Pod \u7ea7\u522b \u8d44\u6e90\u7c7b\u578b:CPU \u548c\u5185\u5b58\u914d\u7f6e Pod\u6574\u4f53\u8d44\u6e90 = \u6240\u6709\u5bb9\u5668\u8d44\u6e90\u548c","title":"Kubernetes \u8d44\u6e90\u6a21\u578b"},{"location":"my-kubernetes/k8s-lesson-20221124/#requestlimit","text":"requests \u548c limits kube-scheduler\u53ea\u4f1a\u6309\u7167requests\u7684\u503c\u8c03\u5ea6\u3002 \u8bbe\u7f6eCgroups\u9650\u5236(Cgroups\u9650\u5236\u5bb9\u5668\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5)\u7684\u65f6\u5019\uff0ckubelet\u5219\u4f1a\u6309\u7167 limits \u7684\u503c \u5355\u4f4d:CPU\u4e2a\u6570;Mi/Gi...;M/G... \u52a8\u6001\u8d44\u6e90\u8fb9\u754c \u5efa\u8bae\uff1a\u4e00\u5b9a\u5728\u5bb9\u5668\u7684\u8d44\u6e90\u8bbe\u7f6e\u4e2d\u52a0\u4e0a requests \u548c limits \u7ecf\u9a8c\uff1a requests \u8bbe\u7f6e\u4fdd\u8bc1\u670d\u52a1\u80fd\u542f\u52a8\u5c31\u884c","title":"\u8d44\u6e90\u8bbe\u7f6e \u2013 request\u548climit"},{"location":"my-kubernetes/k8s-lesson-20221124/#podqos","text":"Guaranteed: Pod\u4e2d\u7684\u6bcf\u4e2a\u5bb9\u5668(\u5305\u542b\u521d\u59cb\u5316\u5bb9\u5668)\u5fc5\u987b\u6307\u5b9arequest\u548climit CPU\u548c\u5185\u5b58\u90fd\u8981\u8bbe\u7f6e Request=limit Burstable Pod\u4e0d\u6ee1\u8db3Guaranteed\u7684\u6761\u4ef6 \u4f46\u81f3\u5c11\u6709\u4e00\u4e2aContainer\u8bbe\u7f6e\u4e86requests BestEffort: Pod\u65e2\u6ca1\u6709\u8bbe\u7f6erequests\uff0c\u4e5f\u6ca1\u6709\u8bbe\u7f6elimits","title":"Pod\u7684\u670d\u52a1\u8d28\u91cf(QoS)"},{"location":"my-kubernetes/k8s-lesson-20221124/#eviction","text":"Eviction:\u5bbf\u4e3b\u673a\u8d44\u6e90\u7d27\u5f20\u65f6\u56de\u6536Pod \u89e6\u53d1\u6761\u4ef6:\u5185\u5b58\u3001\u78c1\u76d8\u7b49 2\u79cd\u6a21\u5f0f Soft:\u4f18\u96c5\u56de\u6536 Hard:\u7acb\u523b\u56de\u6536 \u56de\u6536\u7b56\u7565 \u6839\u636eQoS\u7c7b\u522b \u540c\u7c7b\u522b\u6839\u636e\u4f18\u5148\u7ea7 Guaranteed\u8d85\u8fc7limit\u624d\u8003\u8651\u56de\u6536 cpuset\u8bbe\u7f6e Guaranteed\u7c7b\u578b\uff0crequest=limit\uff0c>=1\u7684\u6574\u6570","title":"\u8d44\u6e90\u56de\u6536(Eviction)"},{"location":"my-kubernetes/k8s-lesson-20221124/#kube-scheduler","text":"\u804c\u8d23:Pod -> Node \u57fa\u672c\u6d41\u7a0b \u68c0\u67e5\u5e76\u6311\u9009Node \u6839\u636e\u9002\u914d\u5ea6\u6253\u5206 \u8c03\u5ea6:\u8bbe\u7f6e spec.nodeName","title":"\u8c03\u5ea6\u5668kube-scheduler"},{"location":"my-kubernetes/k8s-lesson-20221124/#_7","text":"2\u4e2a\u63a7\u5236\u5faa\u73af informer path watch Priority Queue Cache scheduling path \u51fa\u961f \u8fc7\u6ee4 \u6253\u5206 \u7ed1\u5b9a","title":"\u8c03\u5ea6\u5668\u5de5\u4f5c\u539f\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#bind","text":"Assume \u53ea\u66f4\u65b0cache\u7684pod\u3001node\u4fe1\u606f \u907f\u514d\u8fdc\u7a0b\u8bbf\u95eeapiserver Admit kubelet\u505a\u4e8c\u6b21\u786e\u8ba4 \u786e\u8ba4pod\u53ef\u4ee5\u8fd0\u884c\u5728\u88ab\u8c03\u5ea6\u7684node\u4e0a","title":"\u7ed1\u5b9a(Bind)"},{"location":"my-kubernetes/k8s-lesson-20221124/#_8","text":"\u8c03\u5ea6\u5668\u76843\u4e2a\u6027\u80fd\u4f18\u5316 cache\u5316 \u4e50\u89c2\u7ed1\u5b9a(\u5f02\u6b65bind) \u65e0\u9501\u5316 \u542f\u52a8\u591a\u4e2aGoroutine\u4ee5node\u4e3a\u7c92\u5ea6\u5e76\u53d1\u6267\u884cPredicates\u7b97\u6cd5\uff0c\u63d0\u9ad8\u6267\u884c\u6548\u7387 Priorities\u7b97\u6cd5\u4ee5MapReduce\u7684\u65b9\u5f0f\u5e76\u884c\u8ba1\u7b97\u518d\u8fdb\u884c\u6c47\u603b \u907f\u514d\u8bbe\u7f6e\u4efb\u4f55\u5168\u5c40\u7684\u7ade\u4e89\u8d44\u6e90 \u8c03\u5ea6\u5668\u53ea\u6709\u5bf9\u8c03\u5ea6\u961f\u5217\u548cSchedulerCache\u8fdb\u884c\u64cd\u4f5c\u65f6\uff0c\u624d\u9700\u8981\u52a0\u9501","title":"\u8c03\u5ea6\u7684\u6027\u80fd\u4f18\u5316\u8bbe\u8ba1"},{"location":"my-kubernetes/k8s-lesson-20221124/#_9","text":"Scheduling Cycle * Sort, (then pick a pod from scheduling queue) * PreFilter * Filter * PreScore * Score * Normalize Score * Reserve (reserve a node for the pod in cache) * Permit Binding Cycle * WaitOnPermit (internal api) * PreBind * Bind (Bind pod to node) * PostBind","title":"\u8c03\u5ea6\u7684\u53ef\u6269\u5c55\u6027"},{"location":"my-kubernetes/k8s-lesson-20221124/#-predicate","text":"\u672c\u8d28:\u4e00\u7cfb\u5217\u8fc7\u6ee4\u5668(filter) \u529f\u80fd:\u6309\u7167\u8c03\u5ea6\u7b56\u7565\uff0c\u4ece\u6240\u6709\u8282\u70b9\u4e2d\u8fc7\u6ee4\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8282\u70b9 3\u79cd\u7c7b\u578b GeneralPredicates Volume\u76f8\u5173 \u5bbf\u4e3b\u673a\u76f8\u5173 https://kubernetes.io/docs/reference/scheduling/policies/","title":"\u8c03\u5ea6\u7b56\u7565 - predicate"},{"location":"my-kubernetes/k8s-lesson-20221124/#-generalpredicates","text":"\u8d1f\u8d23\u7684\u662f\u6700\u57fa\u7840\u7684\u8c03\u5ea6\u7b56\u7565 \u5e38\u89c1\u7b56\u7565\u4e3e\u4f8b PodFitsResources \u8ba1\u7b97\u7684\u5c31\u662f\u5bbf\u4e3b\u673a\u7684 CPU \u548c\u5185\u5b58\u8d44\u6e90\u7b49\u662f\u5426\u591f\u7528(\u53ea\u68c0\u67e5request) external resource:\u5176\u4ed6\u975e\u6807\u51c6\u8d44\u6e90\u5982gpu\u7528key-value\u65b9\u5f0f\u5b9a\u4e49 PodFitsHost :host = Pod \u7684 spec.nodeName(pod\u8bbe\u7f6e\u4e86) PodFitsHostPorts:Pod \u7533\u8bf7\u7684\u5bbf\u4e3b\u673a\u7aef\u53e3(spec.nodePort)\u662f\u5426\u88ab\u5360\u7528 PodMatchNodeSelector :Pod \u7684 nodeSelector \u6216\u8005 nodeAffinity \u8282\u70b9\uff0c\u662f\u5426\u4e0e\u5f85\u8003\u5bdf\u8282\u70b9\u5339\u914d","title":"\u57fa\u7840\u7b56\u7565 - GeneralPredicates"},{"location":"my-kubernetes/k8s-lesson-20221124/#volume","text":"\u5bb9\u5668\u6301\u4e45\u5316 Volume \u76f8\u5173 \u5e38\u89c1\u7b56\u7565 NoDiskConflict:\u591a\u4e2a Pod \u58f0\u660e\u6302\u8f7d\u7684\u6301\u4e45\u5316 Volume \u662f\u5426\u6709\u51b2\u7a81\u3002 NoVolumeZoneConflict:\u5b58\u50a8\u7684\u6545\u969c\u533a\u57df\u9650\u5236 CheckVolumeBinding:\u6839\u636ePod\u8bf7\u6c42\u7684\u5bb9\u91cf\u548cPVC\u662f\u5426\u5339\u914d LPV \u5fc5\u987b\u4f7f\u7528 nodeAffinity \u8ddf\u67d0\u4e2a\u8282\u70b9\u7ed1\u5b9a","title":"Volume \u7b56\u7565"},{"location":"my-kubernetes/k8s-lesson-20221124/#_10","text":"\u4e3b\u8981\u8003\u5bdf\u5f85\u8c03\u5ea6 Pod \u662f\u5426\u6ee1\u8db3 Node \u672c\u8eab\u7684\u67d0\u4e9b\u6761\u4ef6 PodToleratesNodeTaints:\u6c61\u70b9\u68c0\u67e5","title":"\u5bbf\u4e3b\u673a\u76f8\u5173\u7b56\u7565"},{"location":"my-kubernetes/k8s-lesson-20221124/#predicate","text":"\u5f00\u59cb\u8c03\u5ea6\u4e00\u4e2aPod\u65f6\uff0c\u8c03\u5ea6\u5668\u4f1a\u540c\u65f6\u542f\u52a8 16 \u4e2a Goroutine\u6765\u5e76\u53d1\u5730\u4e3a\u96c6\u7fa4\u91cc\u7684\u6240\u6709 Node \u8ba1\u7b97 Predicates\uff0c\u6700\u540e\u8fd4\u56de\u53ef\u4ee5\u8fd0\u884c\u8fd9\u4e2a Pod \u7684\u5bbf\u4e3b\u673a\u5217\u8868\u3002 \u5728\u4e3a\u6bcf\u4e2aNode\u6267\u884cPredicates\u65f6\uff0c\u8c03\u5ea6 \u5668\u4f1a\u6309\u7167\u56fa\u5b9a\u7684\u987a\u5e8f\u6765\u8fdb\u884c\u68c0\u67e5\u3002","title":"Predicate \u7b56\u7565\u603b\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#-priority","text":"\u529f\u80fd:\u6253\u5206\uff0c\u5f97\u5206\u6700\u9ad8\u5373\u4e3a\u6240\u9009Node \u5e38\u7528\u89c4\u5219: LeastRequestedPriority:\u9009\u62e9\u7a7a\u95f2\u8d44\u6e90\u6700\u591a\u7684\u5bbf\u4e3b\u673a BalancedResourceAllocation:\u8ba1\u7b97\u6bcf\u4e24\u79cd\u8d44\u6e90 Fraction \u4e4b\u95f4\u7684\u201c\u8ddd\u79bb\u201d ImageLocalityPriority:\u8282\u70b9\u4e0a\u6709\u9700\u8981\u7684\u955c\u50cf\uff0c\u5f97\u5206\u8d8a\u9ad8 NodeAffinityPriority:\u8282\u70b9\u4eb2\u548c\u89c4\u5219\uff0c\u6ee1\u8db3\u5b57\u6bb5\u8d8a\u591a\uff0c\u5f97\u5206\u8d8a\u9ad8","title":"\u8c03\u5ea6\u7b56\u7565 - priority"},{"location":"my-kubernetes/k8s-lesson-20221124/#predicate-priority","text":"","title":"\u4ecepredicate\u5230 priority\u7684\u5b8c\u6574\u6d41\u7a0b"},{"location":"my-kubernetes/k8s-lesson-20221124/#_11","text":"\u4f18\u5148\u7ea7\u548c\u62a2\u5360\u662f\u8c03\u5ea6\u5668\u53e6\u4e00\u4e2a\u91cd\u8981\u7279\u6027 \u89e3\u51b3\u95ee\u9898\u7684\u662fPod\u8c03\u5ea6\u5931\u8d25\u540e\u7684\u5982\u4f55\u5904\u7406 \u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2aPod\u8c03\u5ea6\u5931\u8d25\u540e\u4f1a\u88ab\u6682\u65f6\u6302\u8d77\uff0c\u76f4\u5230Pod\u66f4\u65b0\u6216\u96c6\u7fa4\u72b6\u6001\u53d8\u5316\u540e\u518d\u91cd\u65b0\u8c03 \u5ea6 \u4f18\u5148\u7ea7\u7684\u76ee\u7684:\u9ad8\u4f18\u5148\u7ea7\u7684Pod\u8c03\u5ea6\u5931\u8d25\u540e\u6324\u8d70\u4f4e\u4f18\u5148\u7ea7\u7684Pod PreemptionPolicy PreemptLowerPriority Never","title":"\u8c03\u5ea6\u4f18\u5148\u7ea7"},{"location":"my-kubernetes/k8s-lesson-20221124/#preemption","text":"\u4e00\u4e2a\u9ad8\u4f18\u5148\u7ea7\u7684 Pod (\u62a2\u5360\u8005)\u8c03\u5ea6\u5931\u8d25\uff0c\u8c03\u5ea6\u5668\u7684\u62a2\u5360\u80fd\u529b\u88ab\u89e6\u53d1\u3002 \u8c03\u5ea6\u5668\u4f1a\u8bd5\u56fe\u4ece\u5f53\u524d\u96c6\u7fa4\u91cc\u5bfb\u627e\u4e00\u4e2a\u8282\u70b9\uff0c\u5220\u9664\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u4f4e\u4f18\u5148\u7ea7 Pod \u9ad8\u4f18\u5148\u7ea7 Pod \u5c31\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a \u62a2\u5360\u53d1\u751f\u65f6\uff0c\u62a2\u5360\u8005\u4e0d\u4f1a\u7acb\u523b\u88ab\u8c03\u5ea6\u5230Node \u4e0a\u3002 \u8c03\u5ea6\u5668\u53ea\u4f1a\u5c06\u62a2\u5360\u8005\u7684 spec.nominatedNodeName \u5b57\u6bb5\u8bbe\u7f6e\u4e3a\u88ab\u62a2\u5360\u7684 Node \u7684\u540d\u5b57 \u62a2\u5360\u8005\u4f1a\u91cd\u65b0\u8fdb\u5165\u4e0b\u4e00\u4e2a\u8c03\u5ea6\u5468\u671f \u53ef\u80fd\u4f1a\u88ab\u66f4\u9ad8\u7ea7\u522b\u7684\u62a2\u5360\u8005\u63d2\u961f","title":"\u62a2\u5360\u673a\u5236\uff08Preemption\uff09"},{"location":"my-kubernetes/k8s-lesson-20221124/#_12","text":"\u9ad8\u4f18\u5148\u7ea7\u6324\u8d70\u4f4e\u4f18\u5148\u7ea7 \u6838\u5fc3\u5b9e\u73b0:2\u4e2a\u961f\u5217 activeQ unschedulableQ \u6d41\u7a0b \u68c0\u67e5\u5931\u8d25\u539f\u56e0 \u6a21\u62df\u62a2\u5360 \u6267\u884c\u62a2\u5360","title":"\u62a2\u5360\u673a\u5236\u539f\u7406"},{"location":"my-kubernetes/k8s-lesson-20221124/#_13","text":"\u6269\u5c55\u4e86\u4f60\u53ef\u4ee5\u8868\u8fbe\u7ea6\u675f\u7684\u7c7b\u578b 2\u79cd Node\u8282\u70b9\u4eb2\u548c\u6027 pod \u95f4\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027","title":"\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027"},{"location":"my-kubernetes/k8s-lesson-20221124/#_14","text":"affinity.nodeAffinity \u8282\u70b9\u4eb2\u548c\u6027 \u914d\u7f6e \u786c\u9700\u6c42 requiredDuringSchedulingIgnoredDuringExecution \u8f6f\u9700\u6c42 preferredDuringSchedulingIgnoredDuringExecution \u524d\u8005\u6307\u5b9a\u4e86\u5c06 Pod \u8c03\u5ea6\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a \u5fc5\u987b\u6ee1\u8db3\u7684\u89c4\u5219 \u540e\u8005\u6307\u5b9a\u8c03\u5ea6\u5668\u5c06\u5c1d\u8bd5\u6267\u884c\u4f46\u4e0d\u80fd\u4fdd\u8bc1","title":"\u8282\u70b9\u4eb2\u548c\u6027"},{"location":"my-kubernetes/k8s-lesson-20221124/#pod","text":"\u57fa\u4e8e\u5df2\u7ecf\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Pod\u7684\u6807\u7b7e\u6765\u7ea6\u675fPod\u53ef\u4ee5\u8c03\u5ea6\u5230\u7684\u8282\u70b9\uff0c\u800c\u4e0d\u662f\u57fa\u4e8e\u8282\u70b9\u7684\u6807\u7b7e \u89c4\u5219\u683c\u5f0f:\u201c\u5982\u679cX\u8282\u70b9\u4e0a\u5df2\u7ecf\u8fd0\u884c\u4e86\u4e00\u4e2a\u6216\u591a\u4e2a\u6ee1\u8db3\u89c4\u5219Y\u7684Pod\uff0c\u5219\u5f53\u524dPod\u5e94\u8be5(\u6216\u8005\u4e0d\u5e94\u8be5)\u8fd0\u884c\u5728 X \u8282\u70b9\u201d Pod\u95f4\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027\u9700\u8981\u5927\u91cf\u7684\u5904\u7406\uff0c \u53ef\u80fd\u4f1a\u51cf\u6162\u5927\u89c4\u6a21\u96c6\u7fa4\u4e2d\u7684\u8c03\u5ea6 \u914d\u7f6e: requiredDuringSchedulingIgnoredDuringExecution preferredDuringSchedulingIgnoredDuringExecution Pod\u95f4\u4eb2\u548c\u6027\u901a\u8fc7PodSpec\u4e2d affinity \u5b57\u6bb5\u4e0b\u7684 podAffinity \u5b57\u6bb5\u8fdb\u884c\u6307\u5b9a Pod\u95f4\u53cd\u4eb2\u548c\u6027\u901a\u8fc7PodSpec\u4e2d affinity \u5b57\u6bb5\u4e0b\u7684 podAntiAffinity \u5b57\u6bb5\u8fdb\u884c\u6307\u5b9a","title":"Pod\u4eb2\u548c\u6027"},{"location":"my-kubernetes/k8s-lesson-20221124/#_15","text":"Taint(\u6c61\u70b9):\u4f7f\u8282\u70b9\u80fd\u591f\u6392\u65a5\u4e00\u7c7b\u7279\u5b9a\u7684Pod \u5bb9\u5fcd\u5ea6(Tolerations):\u5141\u8bb8Pod\u8c03\u5ea6\u5230\u5e26\u6709\u4e0e\u4e4b\u5339\u914d\u7684\u6c61\u70b9\u7684\u8282\u70b9\u4e0a Node\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u6c61\u70b9 Pod\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2a\u5bb9\u5fcd\u5ea6 \u64cd\u4f5c\u7b26operator Exists Equals effect NoSchedule PreferNoSchedule NoExecute \u5e94\u7528\u573a\u666f \u4e13\u7528\u8282\u70b9 \u7279\u6b8a\u786c\u4ef6\u7684\u8282\u70b9 \u57fa\u4e8e\u6c61\u70b9\u7684\u9a71\u9010 \u6bd4\u5982\u8282\u70b9\u5347\u7ea7\uff1a\u5148\u6253\u6c61\u70b9\u5c06pod\u9a71\u9010\uff0c\u518d\u5347\u7ea7\u8282\u70b9","title":"\u6c61\u70b9\u548c\u5bb9\u5fcd\u5ea6"},{"location":"my-kubernetes/k8s-lesson-20221124/#-limitrange","text":"\u5728namespace\u8303\u56f4\u5185\uff0c\u9650\u5236pod\u6216container\u8d44\u6e90\u4f7f\u7528\u91cf\u7684\u7b56\u7565 \u4f5c\u7528 \u9650\u5236namespace\u4e2d\u6bcf\u4e2apod\u6216container\u7684\u6700\u5c0f\u548c\u6700\u5927\u8d44\u6e90\u7528\u91cf\u3002 \u9650\u5236namespace\u4e2d\u6bcf\u4e2aPVC\u7684\u8d44\u6e90\u8bf7\u6c42\u8303\u56f4\u3002 \u9650\u5236namespace\u4e2d\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u6570\u91cf\u7684\u6bd4\u4f8b\u3002 \u914d\u7f6e\u8d44\u6e90\u7684\u9ed8\u8ba4\u9650\u5236 \u8d44\u6e90\u7c7b\u578b Pod Container PVC \u63a7\u5236\u9650\u5236\u91cf\u548c\u8bf7\u6c42\u91cf\u7684\u6700\u5927\u6bd4\u4f8b\uff0c\u5373limit/request\u8981\u6c42\u5c0f\u4e8e\u7b49\u4e8e maxLimitRequestRatio","title":"\u8d44\u6e90\u7684\u8bf7\u6c42\u548c\u9650\u5236 - LimitRange"},{"location":"my-kubernetes/k8s-lesson-20221124/#_16","text":"\u914d\u7f6e\u89c4\u5219 Request\u3001limit\u90fd\u6709 \u6ca1request\uff0c\u6309limit \u6ca1limit\uff0c\u6309\u9ed8\u8ba4 \u53ea\u5728Pod\u521b\u5efa\u548c\u66f4\u65b0\u65f6\u624d\u5f3a\u5236\u6267\u884c \u66f4\u65b0LimitRange\u4e0d\u4f1a\u5f71\u54cd\u6b64\u524d\u521b\u5efa\u7684Pod \u5e94\u7528\u573a\u666f \u547d\u540d\u7a7a\u95f4\u6709\u914d\u989d\u9650\u5236 \u8d44\u6e90\u603b\u548c\u4e0d\u80fd\u8d85\u8fc7\u8bbe\u5b9a\u503c","title":"\u9650\u5236\u793a\u4f8b"},{"location":"my-kubernetes/k8s-lesson-20221124/#-resoucequtoa","text":"\u5b9e\u73b0\u8d44\u6e90\u6d88\u8017\u603b\u91cf\u7684\u9650\u5236 \u4e24\u4e2a\u4f5c\u7528 \u6309\u7c7b\u578b\u9650\u5236\u547d\u540d\u7a7a\u95f4\u4e0b\u6240\u521b\u5efa\u5bf9\u8c61\u7684\u6570\u91cf \u9650\u5236\u6240\u6d88\u8017\u8ba1\u7b97\u8d44\u6e90\u7684\u603b\u91cf \u8ba1\u7b97\u8d44\u6e90\u914d\u989d \u5b58\u50a8\u914d\u989d \u5bf9\u8c61\u6570\u91cf\u914d\u989d","title":"\u8d44\u6e90\u914d\u989d - ResouceQutoa"},{"location":"my-kubernetes/k8s-lesson-20221124/#_17","text":"\u8c03\u5ea6\u5668\u5de5\u4f5c\u539f\u7406 \u8c03\u5ea6\u7b97\u6cd5\u3001\u7b56\u7565 \u4eb2\u548c\u6027 \u6c61\u70b9\u3001\u5bb9\u5fcd\u5ea6 \u8d44\u6e90\u9650\u5236","title":"\u8c03\u5ea6\u5668\u5c0f\u7ed3"},{"location":"my-kubernetes/k8s-lesson-20221124/#kubernetes_7","text":"https://www.eficode.com/blog/the-future-of-kubernetes-and-why-developers-should-look-beyond-kubernetes-in-2022 \u5b89\u5168\uff1aOIDC vs Secret Secret\u5bf9\u8c61\u8fd8\u662f\u6709\u53ef\u80fd\u4f1a\u88ab\u4fdd\u5b58\u5728pipeline\u4e2d https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#openid-connect-tokens https://kubernetes.io/docs/reference/kubernetes-api/config-and-storage-resources/secret-v1/ \u7f51\u7edc\uff1aGateway API vs Ingress Ingress\u7684\u80fd\u529b\u88ab\u8ba4\u4e3a\u6bd4\u8f83\u5f31\uff0cIngress\u5728service mesh\u91cc\u662f\u4e2a\u9e21\u808b Gateway API https://kubernetes.io/zh-cn/blog/2022/07/13/gateway-api-graduates-to-beta/ https://kubernetes.io/docs/concepts/services-networking/ingress/ \u81ea\u52a8\u6269\u5c55\uff08\u6c34\u5e73\u4f38\u7f29\uff09\uff1aHPA / CA / KEDA HPA\u662f\u57fa\u4e8epod\u5c42\u9762\u7684\u6c34\u5e73\u4f38\u7f29 CA cluster-autoscaling \u662f\u5728node\u5c42\u9762\u7684\u6c34\u5e73\u4f38\u7f29 KEDA\u8ba4\u4e3a\u81ea\u52a8\u6269\u5c55\u4e0d\u4ec5\u4ec5\u662f\u57fa\u4e8e\u8d44\u6e90\u7684\u6269\u5c55\uff0c\u4e5f\u5e94\u8be5\u57fa\u4e8e\u4e8b\u4ef6\u6765\u81ea\u52a8\u6269\u5c55 https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/ https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler https://keda.sh/ \u5b58\u50a8\uff1aPV vs \u5bf9\u8c61\u5b58\u50a8 PV\u4e0d\u662f\u5f88\u597d\u7684practice\uff0c\u6709PV\u610f\u5473\u7740\u5bf9\u5b58\u50a8\u6709\u4f9d\u8d56\uff0c\u5e94\u5c3d\u53ef\u80fd\u57fa\u4e8e\u5bf9\u8c61\u5b58\u50a8 Kubernetes\u672a\u6765\uff1a\u57fa\u4e8eCRD\u7684\u62bd\u8c61\u5e73\u53f0 custom resource definition Kubernetes\u63d0\u4f9b\u4e86CRD\u7684\u6269\u5c55","title":"Kubernetes \u672a\u6765\u5c55\u671b"},{"location":"my-kubernetes/k8s_ha/","text":"# Install Aliyun yum repo for CentOS 7 cd /etc/yum.repos.d/ wget http://mirrors.aliyun.com/repo/Centos-7.repo mv CentOS-Base.repo CentOS-Base.repo.bak mv Centos-7.repo CentOS-Base.repo yum clean all -y && yum makecache -y && yum update -y # Install keepalived + haproxy yum install keepalived haproxy -y \u8bbe\u7f6eHAProxy\u65e5\u5fd7 \u7f16\u8f91 rsyslog \u914d\u7f6e\u6587\u4ef6 /etc/rsyslog.conf \u3002 # \u53d6\u6d88\u6ce8\u91ca\uff0c\u6253\u5f00 UDP syslog \u7684\u63a5\u6536 $ModLoad imudp $UDPServerRun 514 #...... # \u6dfb\u52a0\u8bbe\u5907 local3 # Add local3 as haproxy logging server. local3.* /var/log/haproxy.log \u7f16\u8f91 rsyslog \u8bbe\u7f6e /etc/sysconfig/rsyslog \uff0c\u6765\u63a5\u6536\u8fdc\u7a0b\u670d\u52a1\u5668\u65e5\u5fd7\u3002 #...... SYSLOGD_OPTIONS=\"-r -m 0\" \u91cd\u542f rsyslog service rsyslog restart haproxy \u914d\u7f6e #--------------------------------------------------------------------- # Example configuration for a possible web application. See the # full configuration options online. # # http://haproxy.1wt.eu/download/1.4/doc/configuration.txt # #--------------------------------------------------------------------- global # to have these messages end up in /var/log/haproxy.log you will # need to: # # 1) Configure syslog to accept network log events. # This is done by adding the '-r' option to the SYSLOGD_OPTIONS in `/etc/sysconfig/syslog`. # # 2) Configure local2 events to go to the `/var/log/haproxy.log` file. # A line like the following can be added to `/etc/sysconfig/syslog`: # # local2.* /var/log/haproxy.log # # \u8fd9\u91cc\u8868\u793a\u4f7f\u7528 127.0.0.1 \u4e0a\u7684 rsyslog \u670d\u52a1\u4e2d\u7684 local3 \u65e5\u5fd7\u8bbe\u5907\uff0c\u8bb0\u5f55\u65e5\u5fd7\u7b49\u7ea7\u4e3a info\u3002 # local3 \u662f\u65e5\u5fd7\u8bbe\u5907\uff0cinfo \u8868\u793a\u65e5\u5fd7\u7ea7\u522b\u3002\u6709 err, warning, info, debug 4\u79cd\u65e5\u5fd7\u7ea7\u522b\u3002 log 127.0.0.1 local3 info #chroot /var/lib/haproxy # HAProxy \u5b89\u88c5\u76ee\u5f55 pidfile /var/run/haproxy.pid # \u6307\u5b9a HAProxy \u8fdb\u7a0bID\u7684\u5b58\u653e\u4f4d\u7f6e maxconn 65535 # \u8bbe\u7f6e\u6bcf\u4e2a HAProxy \u8fdb\u7a0b\u53ef\u63a5\u53d7\u7684\u6700\u5927\u5e76\u53d1\u8fde\u63a5\u6570 user nobody # \u8bbe\u7f6e\u542f\u52a8 HAProxy \u8fdb\u7a0b\u7684\u7528\u6237 group nobody # \u8bbe\u7f6e\u542f\u52a8 HAProxy \u8fdb\u7a0b\u7684\u7ec4 #uid 601 # \u8bbe\u7f6e\u542f\u52a8 HAProxy \u8fdb\u7a0b\u7684\u7528\u6237ID\uff08cat /etc/passwd \u67e5\u770b\uff0c\u8fd9\u91cc\u662fnobody\u7684uid\uff09 #gid 601 # \u8bbe\u7f6e\u542f\u52a8 HAProxy \u8fdb\u7a0b\u7684\u7ec4ID\uff08cat /etc/passwd \u67e5\u770b\uff0c\u8fd9\u91cc\u662fnobody\u7684gid\uff09 daemon # \u8bbe\u7f6e HAProxy \u8fdb\u7a0b\u8fdb\u5165\u540e\u53f0\u8fd0\u884c\uff0c\u8fd9\u662f\u63a8\u8350\u7684\u8fd0\u884c\u6a21\u5f0f # turn on stats unix socket stats socket /var/lib/haproxy/stats defaults log global mode http # \u8bbe\u7f6e HAProxy \u5b9e\u4f8b\u9ed8\u8ba4\u7684\u8fd0\u884c\u6a21\u5f0f\uff0c\u6709tcp, http, health\u4e09\u4e2a\u53ef\u9009\u503c option httplog # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cHAProxy\u65e5\u5fd7\u662f\u4e0d\u8bb0\u5f55HTTP\u8bf7\u6c42\u7684\uff0c\u6b64\u9009\u9879\u7684\u4f5c\u7528\u662f\u542f\u7528\u65e5\u5fd7\u8bb0\u5f55HTTP\u8bf7\u6c42 option redispatch # \u6b64\u53c2\u6570\u7528\u4e8ecookie\u4fdd\u6301\u7684\u73af\u5883\u4e2d\u3002 # \u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cHAProxy\u4f1a\u5c06\u5176\u8bf7\u6c42\u7684\u540e\u7aef\u670d\u52a1\u5668\u7684serverID\u63d2\u5165cookie\u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u4f1a\u8bdd\u7684session\u6301\u4e45\u6027\u3002 # \u800c\u5982\u679c\u540e\u7aef\u670d\u52a1\u5668\u51fa\u73b0\u6545\u969c\uff0c\u5ba2\u6237\u7aef\u7684cookie\u662f\u4e0d\u4f1a\u5237\u65b0\u7684\uff0c\u8fd9\u5c31\u4f1a\u9020\u6210\u65e0\u6cd5\u8bbf\u95ee\u3002 # \u6b64\u65f6\uff0c\u5982\u679c\u8bbe\u7f6e\u4e86\u6b64\u53c2\u6570\uff0c\u5c31\u4f1a\u5c06\u5ba2\u6237\u7684\u8bf7\u6c42\u5f3a\u5236\u5b9a\u5411\u5230\u53e6\u5916\u4e00\u53f0\u5065\u5eb7\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\uff0c\u4ee5\u4fdd\u8bc1\u670d\u52a1\u6b63\u5e38\u3002 option http-server-close #option forwardfor except 127.0.0.0/8 retries 3 # \u4e09\u6b21\u8fde\u63a5\u5931\u8d25\uff0c\u5219\u5224\u65ad\u670d\u52a1\u4e0d\u53ef\u7528 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 65535 frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:16443 bind 127.0.0.1:16443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master-hf-1 10.225.21.128:6443 check server k8s-master-hf-2 10.225.21.144:6443 check server k8s-master-hf-3 10.225.21.44:6443 check # server\u7528\u4e8e\u5b9a\u4e49\u591a\u53f0\u540e\u7aef\u771f\u5b9e\u670d\u52a1\u5668\uff0c\u4e0d\u80fd\u7528\u4e8efrontend\u548clisten\u6bb5 # \u683c\u5f0f\u5982\u4e0b\uff1a # server <name> <address>:<port> [param] # `<name>` \u4e3a\u540e\u7aef\u771f\u5b9e\u670d\u52a1\u5668\u6307\u5b9a\u4e00\u4e2a\u5185\u90e8\u540d\u79f0\uff0c\u968f\u4fbf\u5b9a\u4e49\u4e00\u4e2a\u5373\u53ef # `<address>:<port>` \u6307\u5b9a\u540e\u7aef\u670d\u52a1\u5668\u7684IP\u5730\u5740\u53ca\u7aef\u53e3 # [param]\u53c2\u6570: # check \u8868\u793a\u542f\u7528\u5bf9\u6b64\u540e\u7aef\u670d\u52a1\u5668\u6267\u884c\u5065\u5eb7\u72b6\u6001\u68c0\u67e5 # inter \u8bbe\u7f6e\u5065\u5eb7\u72b6\u6001\u68c0\u67e5\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u5355\u4f4d\u662f\u6beb\u79d2 # rise \u68c0\u67e5\u591a\u5c11\u6b21\u8ba4\u4e3a\u670d\u52a1\u5668\u53ef\u7528 # fall \u68c0\u67e5\u591a\u5c11\u6b21\u8ba4\u4e3a\u670d\u52a1\u5668\u4e0d\u53ef\u7528 # weight \u8bbe\u7f6e\u670d\u52a1\u5668\u7684\u6743\u91cd\uff0c\u9ed8\u8ba4\u4e3a1\uff0c\u6700\u5927\u4e3a256\u3002\u8bbe\u7f6e\u4e3a0\u8868\u793a\u4e0d\u53c2\u4e0e\u8d1f\u8f7d\u5747\u8861 # backup \u8bbe\u7f6e\u5907\u4efd\u670d\u52a1\u5668\uff0c\u7528\u4e8e\u6240\u6709\u540e\u7aef\u670d\u52a1\u5668\u5168\u90e8\u4e0d\u53ef\u7528\u65f6 # cookie \u4e3a\u6307\u5b9a\u7684\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6ecookie\u503c\uff0c\u6b64\u5904\u6307\u5b9a\u7684\u503c\u5c06\u5728\u8bf7\u6c42\u5165\u7ad9\u65f6\u88ab\u68c0\u67e5\uff0c\u7b2c\u4e00\u6b21\u4e3a\u6b64\u503c\u6311\u9009\u7684\u540e\u7aef\u670d\u52a1\u5668\u5c06\u5728\u540e\u7eed\u7684\u8bf7\u6c42\u4e2d\u4e00\u76f4\u88ab\u9009\u4e2d\uff0c\u5176\u76ee\u7684\u5728\u4e8e\u5b9e\u73b0\u6301\u4e45\u8fde\u63a5\u7684\u529f\u80fd Sample: global log 127.0.0.1 local3 info pidfile /var/run/haproxy.pid maxconn 65535 user nobody group nobody daemon stats socket /var/lib/haproxy/stats defaults log global mode http option httplog option redispatch option http-server-close retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 65535 frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:16443 bind 127.0.0.1:16443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master-hf-1 10.225.21.128:6443 check server k8s-master-hf-2 10.225.21.144:6443 check server k8s-master-hf-3 10.225.21.44:6443 check Keepalived /etc/keepalived/keepalived.conf: ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_k8s_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state MASTER interface eth0 mcast_src_ip 10.225.21.128 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 10.225.21.128 } } another config on master2 ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_k8s_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface eth0 mcast_src_ip 10.225.21.144 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 10.225.21.128 } } \u6d4b\u8bd5\u811a\u672ccheck_k8s_apiserver.sh #!/bin/bash err=0 for k in $(seq 1 3) do check_code=$(pgrep haproxy) if [[ $check_code == \"\" ]]; then err=$(expr $err + 1) sleep 1 continue else err=0 break fi done if [[ $err != \"0\" ]]; then echo \"systemctl stop keepalived\" /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi \u8bbe\u7f6e\u4e3a\u53ef\u6267\u884c chmod +x /etc/keepalived/check_k8s_apiserver.sh \u542f\u52a8haproxy\u548ckeepalived systemctl daemon-reload systemctl enable --now haproxy systemctl enable --now keepalived ping 10.225.21.128 -c 4 curl -k https://10.225.21.128:16443/livez?verbose yum install nc -y nc -v 10.225.21.128 16443 \u52a0\u5165\u8282\u70b9 \u751f\u6210/\u83b7\u53d6 kubeadm token kubeadm token create && kubeadm token list \u83b7\u53d6\u8bc1\u4e66 hash openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \\ openssl dgst -sha256 -hex | sed 's/^.* //' \u83b7\u53d6\u8bc1\u4e66 key kubeadm certs certificate-key \u4f5c\u4e3a\u63a7\u5236\u5e73\u9762\u52a0\u5165\u96c6\u7fa4 kubeadm join 10.225.21.128:16443 --token ${token} \\ --discovery-token-ca-cert-hash sha256:${hash} \\ --control-plane --certificate-key ${key} kubeadm join 10.225.21.128:16443 --token qsjxyh.g9ogxlk4mv0ehs4e \\ --discovery-token-ca-cert-hash sha256:dadafac1a66ea22a9c5cf89c104e6988f9c3009a6a62c59ee14e22db5df23c79 \\ --control-plane --certificate-key 6fc60f413f42a63d7de8d9376ec6c87f9087661c2f211d9e820fe52226bf809e","title":"K8s ha"},{"location":"my-kubernetes/k8s_installation/","text":"Kubernetes \u96c6\u7fa4\u642d\u5efa # Training of Cloud-Native Kubernetes for Development. \u5185\u5bb9\u63d0\u8981 \u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd) cgroup \u9a71\u52a8\u914d\u7f6e \u5728 Linux \u7cfb\u7edf\u4e2d\u5b89\u88c5 kubectl \u53ca\u5176\u63d2\u4ef6 Kubernetes \u672a\u6765\u5c55\u671b \u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd) # \u5b89\u88c5 containerd \u5b89\u88c5 runc \u5b89\u88c5 CNI \u63d2\u4ef6 \u914d\u7f6e containerd \u8be6\u89c1\uff1a \u5bb9\u5668\u8fd0\u884c\u65f6\u5b89\u88c5 \u5b89\u88c5\u548c\u914d\u7f6e\u5148\u51b3\u6761\u4ef6 # \u8f6c\u53d1 IPv4 \u5e76\u8ba9 iptables \u770b\u5230\u6865\u63a5\u6d41\u91cf # \u4e3a\u4e86\u8ba9 Linux \u8282\u70b9\u7684 iptables \u80fd\u591f\u6b63\u786e\u67e5\u770b\u6865\u63a5\u6d41\u91cf\uff0c\u8bf7\u786e\u8ba4 sysctl \u914d\u7f6e\u4e2d\u7684 net.bridge.bridge-nf-call-iptables \u8bbe\u7f6e\u4e3a 1\u3002\u4f8b\u5982\uff1a # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s/config && cd /usr/nzhong/k8s/config #cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf cat <<EOF | sudo tee /usr/nzhong/k8s/config/k8s_modules_load_d.conf overlay br_netfilter EOF cp k8s_modules_load_d.conf /etc/modules-load.d/k8s.conf sudo modprobe overlay sudo modprobe br_netfilter ## \u8bbe\u7f6e\u6240\u9700\u7684 sysctl \u53c2\u6570\uff0c\u53c2\u6570\u5728\u91cd\u65b0\u542f\u52a8\u540e\u4fdd\u6301\u4e0d\u53d8 #cat > k8s_sysctl_d.conf <<EOF #cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf #net.bridge.bridge-nf-call-iptables = 1 #net.bridge.bridge-nf-call-ip6tables = 1 #net.ipv4.ip_forward = 1 #EOF # ## \u5e94\u7528 sysctl \u53c2\u6570\u800c\u4e0d\u91cd\u65b0\u542f\u52a8 #sudo sysctl --system # \u8c03\u6574\u5185\u6838\u53c2\u6570\uff0c\u914d\u7f6eK8S\u73af\u5883 cat > k8s_sysctl_d.conf <<EOF net.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.ipv4.ip_forward=1 net.ipv4.tcp_tw_recycle=0 vm.swappiness=0 #\u7981\u6b62\u4f7f\u7528swap\u7a7a\u95f4\uff0c\u53ea\u6709\u5f53\u7cfb\u7edfOOM\u65f6\u624d\u5141\u8bb8\u4f7f\u7528 vm.overcommit_memory=1 #\u4e0d\u68c0\u67e5\u7269\u7406\u5185\u5b58\u662f\u5426\u591f\u7528 vm.panic_on_oom=0 fs.inotify.max_user_instances=8192 fs.inotify.max_user_watches=1048576 fs.file-max=52706963 fs.nr_open=52706963 net.ipv6.conf.all.disable_ipv6=1 net.netfilter.nf_conntrack_max=2310720 EOF cp k8s_sysctl_d.conf /etc/sysctl.d/kubernetes.conf sysctl -p /etc/sysctl.d/kubernetes.conf cgroup \u9a71\u52a8\u914d\u7f6e # kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u9700\u8981\u4f7f\u7528\u4e00\u4e2a cgroup \u9a71\u52a8\u3002 \u5173\u952e\u7684\u4e00\u70b9\u662f kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u9700\u4f7f\u7528\u76f8\u540c\u7684 cgroup \u9a71\u52a8\u5e76\u4e14\u91c7\u7528\u76f8\u540c\u7684\u914d\u7f6e\u3002 \u53ef\u7528\u7684 cgroup \u9a71\u52a8\u6709\u4e24\u4e2a\uff1a cgroupfs systemd https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#cgroup-drivers cgroupfs \u9a71\u52a8 # cgroupfs \u9a71\u52a8\u662f kubelet \u4e2d \u9ed8\u8ba4\u7684 cgroup \u9a71\u52a8 \u3002\u5f53\u4f7f\u7528 cgroupfs \u9a71\u52a8\u65f6\uff0ckubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u5c06\u76f4\u63a5\u5bf9\u63a5 cgroup \u6587\u4ef6\u7cfb\u7edf\u6765\u914d\u7f6e cgroup\u3002 \u5f53 systemd \u662f\u521d\u59cb\u5316\u7cfb\u7edf\u65f6\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528 cgroupfs \u9a71\u52a8 \uff0c\u56e0\u4e3a systemd \u671f\u671b\u7cfb\u7edf\u4e0a\u53ea\u6709\u4e00\u4e2a cgroup \u7ba1\u7406\u5668\u3002 \u6b64\u5916\uff0c\u5982\u679c\u4f60\u4f7f\u7528 cgroup v2\uff0c\u5219\u5e94\u7528 systemd cgroup \u9a71\u52a8\u53d6\u4ee3 cgroupfs\u3002 systemd cgroup \u9a71\u52a8 # \u540c\u65f6\u5b58\u5728\u4e24\u4e2a cgroup \u7ba1\u7406\u5668\u5c06\u9020\u6210\u7cfb\u7edf\u4e2d\u9488\u5bf9\u53ef\u7528\u7684\u8d44\u6e90\u548c\u4f7f\u7528\u4e2d\u7684\u8d44\u6e90\u51fa\u73b0\u4e24\u4e2a\u89c6\u56fe\u3002 \u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u5c06 kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u914d\u7f6e\u4e3a\u4f7f\u7528 cgroupfs\u3001\u4f46\u4e3a\u5269\u4f59\u7684\u8fdb\u7a0b\u4f7f\u7528 systemd \u7684\u90a3\u4e9b\u8282\u70b9\u5c06\u5728\u8d44\u6e90\u538b\u529b\u589e\u5927\u65f6\u53d8\u5f97\u4e0d\u7a33\u5b9a\u3002 \u5f53 systemd \u662f\u9009\u5b9a\u7684\u521d\u59cb\u5316\u7cfb\u7edf\u65f6\uff0c\u7f13\u89e3\u8fd9\u4e2a\u4e0d\u7a33\u5b9a\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u9488\u5bf9 kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u5c06 systemd \u7528\u4f5c cgroup \u9a71\u52a8\u3002 \u8981\u5c06 systemd \u8bbe\u7f6e\u4e3a cgroup \u9a71\u52a8\uff0c\u9700\u7f16\u8f91 KubeletConfiguration \u7684 cgroupDriver \u9009\u9879\uff0c\u5e76\u5c06\u5176\u8bbe\u7f6e\u4e3a systemd\u3002\u4f8b\u5982\uff1a apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration #... cgroupDriver: systemd \u5982\u679c\u4f60\u5c06 systemd \u914d\u7f6e\u4e3a kubelet \u7684 cgroup \u9a71\u52a8\uff0c\u4f60\u4e5f\u5fc5\u987b\u5c06 systemd \u914d\u7f6e\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6\u7684 cgroup \u9a71\u52a8\u3002 https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#systemd-cgroup-driver \u5c06 systemd \u914d\u7f6e\u4e3a containerd \u7684 cgroup \u9a71\u52a8 # \u4f7f\u7528 containerd \u4f5c\u4e3a CRI \u8fd0\u884c\u65f6\u7684\u5fc5\u8981\u6b65\u9aa4\u3002 \u5728\u8def\u5f84 /etc/containerd/config.toml \u4e0b\u627e\u5230\u914d\u7f6e\u6587\u4ef6\u3002\u5728 Linux \u4e0a\uff0ccontainerd \u7684\u9ed8\u8ba4 CRI \u5957\u63a5\u5b57\u662f /run/containerd/containerd.sock \u3002 \u7ed3\u5408 runc \u4f7f\u7528 systemd cgroup \u9a71\u52a8\uff0c\u5728 /etc/containerd/config.toml \u4e2d\u8bbe\u7f6e\uff1a [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc] ... [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] SystemdCgroup = true \u8bf4\u660e\uff1a \u5982\u679c\u4f60\u4ece\u8f6f\u4ef6\u5305\uff08\u4f8b\u5982\uff0cRPM \u6216\u8005 .deb\uff09\u4e2d\u5b89\u88c5 containerd\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u5176\u4e2d\u9ed8\u8ba4\u7981\u6b62\u4e86 CRI \u96c6\u6210\u63d2\u4ef6\u3002 \u4f60\u9700\u8981\u542f\u7528 CRI \u652f\u6301\u624d\u80fd\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528 containerd\u3002 \u8981\u786e\u4fdd cri \u6ca1\u6709\u51fa\u73b0\u5728 /etc/containerd/config.toml \u6587\u4ef6\u4e2d disabled_plugins \u5217\u8868\u5185\u3002\u5982\u679c\u4f60\u66f4\u6539\u4e86\u8fd9\u4e2a\u6587\u4ef6\uff0c\u4e5f\u8bf7\u8bb0\u5f97\u8981\u91cd\u542f containerd\u3002 \u5982\u679c\u4f60\u5e94\u7528\u6b64\u66f4\u6539\uff0c\u8bf7\u786e\u4fdd\u91cd\u65b0\u542f\u52a8 containerd\uff1a sudo systemctl restart containerd \u5728 Linux \u7cfb\u7edf\u4e2d\u5b89\u88c5 kubectl \u53ca\u5176\u63d2\u4ef6 # kubectl \u7684\u4e8c\u8fdb\u5236\u5b89\u88c5 # https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s && cd /usr/nzhong/k8s # Download the latest stable version. #curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\" # Get the latest stable version. #curl -L -s https://dl.k8s.io/release/stable.txt # Download the particular version of \"v1.26.0\". curl -LO https://dl.k8s.io/release/v1.26.0/bin/linux/amd64/kubectl # Install kubectl. sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl # Verify the installed version. kubectl version --client \u9a8c\u8bc1 kubectl \u914d\u7f6e # \u4e3a\u4e86\u8ba9 kubectl \u80fd\u53d1\u73b0\u5e76\u8bbf\u95ee Kubernetes \u96c6\u7fa4\uff0c\u4f60\u9700\u8981\u4e00\u4e2a kubeconfig \u6587\u4ef6\u3002 \u901a\u5e38 kubectl \u7684\u914d\u7f6e\u4fe1\u606f\u5b58\u653e\u4e8e\u6587\u4ef6 ~/.kube/config \u4e2d\u3002 \u901a\u8fc7\u83b7\u53d6\u96c6\u7fa4\u72b6\u6001\u7684\u65b9\u6cd5\uff0c\u68c0\u67e5\u662f\u5426\u5df2\u6070\u5f53\u7684\u914d\u7f6e\u4e86 kubectl\uff0c\u5982\u679c\u8fd4\u56de\u4e00\u4e2a URL\uff0c\u5219\u610f\u5473\u7740 kubectl \u6210\u529f\u7684\u8bbf\u95ee\u5230\u4e86\u4f60\u7684\u96c6\u7fa4\u3002 kubectl cluster-info shell \u81ea\u52a8\u8865\u5168\u529f\u80fd # TODO \u5b89\u88c5 kubectl convert \u63d2\u4ef6 # kubectl-convert \u5141\u8bb8\u4f60\u5c06\u6e05\u5355\u5728\u4e0d\u540c API \u7248\u672c\u95f4\u8f6c\u6362\u3002 \u8fd9\u5bf9\u4e8e\u5c06\u6e05\u5355\u8fc1\u79fb\u5230\u65b0\u7684 Kubernetes \u53d1\u884c\u7248\u4e0a\u672a\u88ab\u5e9f\u5f03\u7684 API \u7248\u672c\u65f6\u5c24\u5176\u6709\u5e2e\u52a9\u3002 # Download the latest kubectl-convert package. curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl-convert\" # Install kubectl-convert. sudo install -o root -g root -m 0755 kubectl-convert /usr/local/bin/kubectl-convert # Verify the installed version. kubectl convert --help \u4f7f\u7528 kubeadm \u5f15\u5bfc\u96c6\u7fa4 # \u51c6\u5907\u5de5\u4f5c Linux \u4e3b\u673a\u3002Kubernetes \u9879\u76ee\u4e3a\u57fa\u4e8e Debian \u548c Red Hat \u7684 Linux \u53d1\u884c\u7248\u4ee5\u53ca\u4e00\u4e9b\u4e0d\u63d0\u4f9b\u5305\u7ba1\u7406\u5668\u7684\u53d1\u884c\u7248\u63d0\u4f9b\u901a\u7528\u7684\u6307\u4ee4\u3002 \u6bcf\u53f0\u673a\u5668 2 GB \u6216\u66f4\u591a\u7684 RAM\uff08\u5982\u679c\u5c11\u4e8e\u8fd9\u4e2a\u6570\u5b57\u5c06\u4f1a\u5f71\u54cd\u4f60\u5e94\u7528\u7684\u8fd0\u884c\u5185\u5b58\uff09\u3002 CPU 2 \u6838\u5fc3\u53ca\u4ee5\u4e0a\u3002 \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u673a\u5668\u7684\u7f51\u7edc\u5f7c\u6b64\u5747\u80fd\u76f8\u4e92\u8fde\u63a5\uff08\u516c\u7f51\u548c\u5185\u7f51\u90fd\u53ef\u4ee5\uff09\u3002 \u8282\u70b9\u4e4b\u4e2d\u4e0d\u53ef\u4ee5\u6709\u91cd\u590d\u7684\u4e3b\u673a\u540d\u3001MAC \u5730\u5740\u6216 product_uuid\u3002 \u5f00\u542f\u673a\u5668\u4e0a\u7684\u67d0\u4e9b\u7aef\u53e3\u3002 \u7981\u7528\u4ea4\u6362\u5206\u533a\u3002\u4e3a\u4e86\u4fdd\u8bc1 kubelet \u6b63\u5e38\u5de5\u4f5c\uff0c\u4f60\u5fc5\u987b\u7981\u7528\u4ea4\u6362\u5206\u533a\u3002 \u786e\u4fdd\u6bcf\u4e2a\u8282\u70b9\u4e0a MAC \u5730\u5740\u548c product_uuid \u7684\u552f\u4e00\u6027 # \u901a\u8fc7\u547d\u4ee4 ip link \u6216 ifconfig -a \u83b7\u53d6\u7f51\u7edc\u63a5\u53e3\u7684 MAC \u5730\u5740\u3002 \u4f7f\u7528\u547d\u4ee4 sudo cat /sys/class/dmi/id/product_uuid \u5bf9 product_uuid \u6821\u9a8c \u91cd\u547d\u540d\u4e3b\u673a\u540d\u4f7f\u8282\u70b9\u65b9\u4fbf\u7ba1\u7406 # \u5efa\u8bae\u624b\u5de5\u64cd\u4f5c hostname ${NEW_HOSTNAME} echo \"${NEW_HOSTNAME}\" > /etc/hostname echo \"HOSTNAME=${NEW_HOSTNAME}\" >> /etc/sysconfig/network echo \"${IP_ADDRESS} ${NEW_HOSTNAME} ${NEW_HOSTNAME}\" >> /etc/hosts \u68c0\u67e5\u6240\u9700\u7aef\u53e3 # \u53ef\u4ee5\u4f7f\u7528 netcat \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u68c0\u67e5\u7aef\u53e3\u662f\u5426\u542f\u7528\uff1a nc 127.0.0.1 6443 \u5b89\u88c5 kubeadm\u3001kubelet # kubeadm \uff1a\u7528\u6765\u521d\u59cb\u5316\u96c6\u7fa4\u7684\u6307\u4ee4\u3002 kubelet \uff1a\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7528\u6765\u542f\u52a8 Pod \u548c\u5bb9\u5668\u7b49\u3002 kubectl \uff1a\u7528\u6765\u4e0e\u96c6\u7fa4\u901a\u4fe1\u7684\u547d\u4ee4\u884c\u5de5\u5177\u3002 \u57fa\u4e8e Red Hat \u7cfb\u53d1\u884c\u7248 # \u914d\u7f6eyum repo\uff0c\u5899\u5185\u7528\u6237\u53ef\u914d\u7f6e\u5176\u4ed6\u6e90 cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF # Install epel-release as yum repo for CentOS 7 servers. yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm # \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\uff08\u76f8\u5f53\u4e8e\u5c06\u5176\u7981\u7528\uff09 # \u901a\u8fc7\u8fd0\u884c\u547d\u4ee4 setenforce 0 \u548c sed ... \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\u53ef\u4ee5\u6709\u6548\u5730\u5c06\u5176\u7981\u7528\u3002\u8fd9\u662f\u5141\u8bb8\u5bb9\u5668\u8bbf\u95ee\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u6240\u5fc5\u9700\u7684\uff0c\u800c\u8fd9\u4e9b\u64cd\u4f5c\u662f\u4e3a\u4e86\u4f8b\u5982 Pod \u7f51\u7edc\u5de5\u4f5c\u6b63\u5e38\u3002 # \u4f60\u5fc5\u987b\u8fd9\u4e48\u505a\uff0c\u76f4\u5230 kubelet \u505a\u51fa\u5bf9 SELinux \u7684\u652f\u6301\u8fdb\u884c\u5347\u7ea7\u4e3a\u6b62\u3002 sudo setenforce 0 && sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config # \u5173\u95ed\u865a\u62df\u5185\u5b58\u5206\u533a\uff0c\u9632\u6b62 k8s \u7684 pod \u88ab\u5206\u914d\u5230\u865a\u62df\u5185\u5b58\u8fd0\u884c\uff0c\u4ece\u800c\u5f71\u54cd\u4ea7\u7ebf\u8fd0\u884c\u6548\u80fd\u3002\u9700\u8981 reboot\u3002 sudo swapoff -a && sudo sed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes sudo systemctl enable --now kubelet kubeadm \u521d\u59cb\u5316\u96c6\u7fa4 # \u521d\u59cb\u5316 kubeadm \u914d\u7f6e\u6587\u4ef6 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s/config && cd /usr/nzhong/k8s/config # Export default init config. kubeadm config print init-defaults > kubeadm-config-init-defaults.yaml # Export default join config. kubeadm config print join-defaults > kubeadm-config-join-defaults.yaml \u6839\u636e kubeadm \u914d\u7f6e (v1beta3) \u624b\u5de5\u4fee\u6539\u4e0a\u8ff0\u751f\u6210\u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\uff0c \u5220\u9664\u4f60\u4e0d\u786e\u5b9a\u7684\u5b57\u6bb5 \u3002 kubeadm \u914d\u7f6e (v1beta3) # init-defaults apiVersion: kubeadm.k8s.io/v1beta3 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 1.2.3.4 bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: node taints: null --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: {} etcd: local: dataDir: /var/lib/etcd imageRepository: registry.k8s.io kind: ClusterConfiguration kubernetesVersion: 1.26.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 scheduler: {} \u66f4\u65b0 apiVersion: kubeadm.k8s.io/v1beta3 kind: InitConfiguration localAPIEndpoint: advertiseAddress: 10.225.36.57 bindPort: 6443 nodeRegistration: criSocket: unix:///run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: k8s-master-1 --- apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: nzhong-k8s-hz01 #controllerManager: {} #dns: {} apiServer: timeoutForControlPlane: 4m0s etcd: local: imageRepository: \"gcr.io/etcd-development\" imageTag: \"v3.4.23\" dataDir: /var/lib/etcd imageRepository: registry.k8s.io kind: ClusterConfiguration kubernetesVersion: 1.26.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/16 podSubnet: 10.100.0.0/16 --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration # kubelet specific options here cgroupDriver: systemd --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration \u521d\u59cb\u5316\u63a7\u5236\u5e73\u9762(\u4e3b\u63a7\u8282\u70b9) # kubeadm init --config=kubeadm-init.yaml --upload-certs | tee kubeadm-log.log mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config root\u7528\u6237 export KUBECONFIG=/etc/kubernetes/admin.conf CNI\u63d2\u4ef6\u914d\u7f6e # cat << EOF | tee /etc/cni/net.d/10-containerd-net.conflist { \"cniVersion\": \"1.0.0\", \"name\": \"containerd-net\", \"plugins\": [ { \"type\": \"bridge\", \"bridge\": \"cni0\", \"isGateway\": true, \"ipMasq\": true, \"promiscMode\": true, \"ipam\": { \"type\": \"host-local\", \"ranges\": [ [{ \"subnet\": \"10.96.0.0/16\" }], [{ \"subnet\": \"10.100.0.0/16\" }] ], \"routes\": [ { \"dst\": \"0.0.0.0/0\" }, { \"dst\": \"::/0\" } ] } }, { \"type\": \"portmap\", \"capabilities\": {\"portMappings\": true}, \"externalSetMarkChain\": \"KUBE-MARK-MASQ\" } ] } EOF","title":"Kubernetes \u96c6\u7fa4\u642d\u5efa"},{"location":"my-kubernetes/k8s_installation/#kubernetes","text":"Training of Cloud-Native Kubernetes for Development. \u5185\u5bb9\u63d0\u8981 \u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd) cgroup \u9a71\u52a8\u914d\u7f6e \u5728 Linux \u7cfb\u7edf\u4e2d\u5b89\u88c5 kubectl \u53ca\u5176\u63d2\u4ef6 Kubernetes \u672a\u6765\u5c55\u671b","title":"Kubernetes \u96c6\u7fa4\u642d\u5efa"},{"location":"my-kubernetes/k8s_installation/#containerd","text":"\u5b89\u88c5 containerd \u5b89\u88c5 runc \u5b89\u88c5 CNI \u63d2\u4ef6 \u914d\u7f6e containerd \u8be6\u89c1\uff1a \u5bb9\u5668\u8fd0\u884c\u65f6\u5b89\u88c5","title":"\u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd)"},{"location":"my-kubernetes/k8s_installation/#_1","text":"","title":"\u5b89\u88c5\u548c\u914d\u7f6e\u5148\u51b3\u6761\u4ef6"},{"location":"my-kubernetes/k8s_installation/#ipv4-iptables","text":"\u4e3a\u4e86\u8ba9 Linux \u8282\u70b9\u7684 iptables \u80fd\u591f\u6b63\u786e\u67e5\u770b\u6865\u63a5\u6d41\u91cf\uff0c\u8bf7\u786e\u8ba4 sysctl \u914d\u7f6e\u4e2d\u7684 net.bridge.bridge-nf-call-iptables \u8bbe\u7f6e\u4e3a 1\u3002\u4f8b\u5982\uff1a # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s/config && cd /usr/nzhong/k8s/config #cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf cat <<EOF | sudo tee /usr/nzhong/k8s/config/k8s_modules_load_d.conf overlay br_netfilter EOF cp k8s_modules_load_d.conf /etc/modules-load.d/k8s.conf sudo modprobe overlay sudo modprobe br_netfilter ## \u8bbe\u7f6e\u6240\u9700\u7684 sysctl \u53c2\u6570\uff0c\u53c2\u6570\u5728\u91cd\u65b0\u542f\u52a8\u540e\u4fdd\u6301\u4e0d\u53d8 #cat > k8s_sysctl_d.conf <<EOF #cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf #net.bridge.bridge-nf-call-iptables = 1 #net.bridge.bridge-nf-call-ip6tables = 1 #net.ipv4.ip_forward = 1 #EOF # ## \u5e94\u7528 sysctl \u53c2\u6570\u800c\u4e0d\u91cd\u65b0\u542f\u52a8 #sudo sysctl --system # \u8c03\u6574\u5185\u6838\u53c2\u6570\uff0c\u914d\u7f6eK8S\u73af\u5883 cat > k8s_sysctl_d.conf <<EOF net.bridge.bridge-nf-call-iptables=1 net.bridge.bridge-nf-call-ip6tables=1 net.ipv4.ip_forward=1 net.ipv4.tcp_tw_recycle=0 vm.swappiness=0 #\u7981\u6b62\u4f7f\u7528swap\u7a7a\u95f4\uff0c\u53ea\u6709\u5f53\u7cfb\u7edfOOM\u65f6\u624d\u5141\u8bb8\u4f7f\u7528 vm.overcommit_memory=1 #\u4e0d\u68c0\u67e5\u7269\u7406\u5185\u5b58\u662f\u5426\u591f\u7528 vm.panic_on_oom=0 fs.inotify.max_user_instances=8192 fs.inotify.max_user_watches=1048576 fs.file-max=52706963 fs.nr_open=52706963 net.ipv6.conf.all.disable_ipv6=1 net.netfilter.nf_conntrack_max=2310720 EOF cp k8s_sysctl_d.conf /etc/sysctl.d/kubernetes.conf sysctl -p /etc/sysctl.d/kubernetes.conf","title":"\u8f6c\u53d1 IPv4 \u5e76\u8ba9 iptables \u770b\u5230\u6865\u63a5\u6d41\u91cf"},{"location":"my-kubernetes/k8s_installation/#cgroup","text":"kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u9700\u8981\u4f7f\u7528\u4e00\u4e2a cgroup \u9a71\u52a8\u3002 \u5173\u952e\u7684\u4e00\u70b9\u662f kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u9700\u4f7f\u7528\u76f8\u540c\u7684 cgroup \u9a71\u52a8\u5e76\u4e14\u91c7\u7528\u76f8\u540c\u7684\u914d\u7f6e\u3002 \u53ef\u7528\u7684 cgroup \u9a71\u52a8\u6709\u4e24\u4e2a\uff1a cgroupfs systemd https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#cgroup-drivers","title":"cgroup \u9a71\u52a8\u914d\u7f6e"},{"location":"my-kubernetes/k8s_installation/#cgroupfs","text":"cgroupfs \u9a71\u52a8\u662f kubelet \u4e2d \u9ed8\u8ba4\u7684 cgroup \u9a71\u52a8 \u3002\u5f53\u4f7f\u7528 cgroupfs \u9a71\u52a8\u65f6\uff0ckubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u5c06\u76f4\u63a5\u5bf9\u63a5 cgroup \u6587\u4ef6\u7cfb\u7edf\u6765\u914d\u7f6e cgroup\u3002 \u5f53 systemd \u662f\u521d\u59cb\u5316\u7cfb\u7edf\u65f6\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528 cgroupfs \u9a71\u52a8 \uff0c\u56e0\u4e3a systemd \u671f\u671b\u7cfb\u7edf\u4e0a\u53ea\u6709\u4e00\u4e2a cgroup \u7ba1\u7406\u5668\u3002 \u6b64\u5916\uff0c\u5982\u679c\u4f60\u4f7f\u7528 cgroup v2\uff0c\u5219\u5e94\u7528 systemd cgroup \u9a71\u52a8\u53d6\u4ee3 cgroupfs\u3002","title":"cgroupfs \u9a71\u52a8"},{"location":"my-kubernetes/k8s_installation/#systemd-cgroup","text":"\u540c\u65f6\u5b58\u5728\u4e24\u4e2a cgroup \u7ba1\u7406\u5668\u5c06\u9020\u6210\u7cfb\u7edf\u4e2d\u9488\u5bf9\u53ef\u7528\u7684\u8d44\u6e90\u548c\u4f7f\u7528\u4e2d\u7684\u8d44\u6e90\u51fa\u73b0\u4e24\u4e2a\u89c6\u56fe\u3002 \u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u5c06 kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u914d\u7f6e\u4e3a\u4f7f\u7528 cgroupfs\u3001\u4f46\u4e3a\u5269\u4f59\u7684\u8fdb\u7a0b\u4f7f\u7528 systemd \u7684\u90a3\u4e9b\u8282\u70b9\u5c06\u5728\u8d44\u6e90\u538b\u529b\u589e\u5927\u65f6\u53d8\u5f97\u4e0d\u7a33\u5b9a\u3002 \u5f53 systemd \u662f\u9009\u5b9a\u7684\u521d\u59cb\u5316\u7cfb\u7edf\u65f6\uff0c\u7f13\u89e3\u8fd9\u4e2a\u4e0d\u7a33\u5b9a\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u9488\u5bf9 kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u5c06 systemd \u7528\u4f5c cgroup \u9a71\u52a8\u3002 \u8981\u5c06 systemd \u8bbe\u7f6e\u4e3a cgroup \u9a71\u52a8\uff0c\u9700\u7f16\u8f91 KubeletConfiguration \u7684 cgroupDriver \u9009\u9879\uff0c\u5e76\u5c06\u5176\u8bbe\u7f6e\u4e3a systemd\u3002\u4f8b\u5982\uff1a apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration #... cgroupDriver: systemd \u5982\u679c\u4f60\u5c06 systemd \u914d\u7f6e\u4e3a kubelet \u7684 cgroup \u9a71\u52a8\uff0c\u4f60\u4e5f\u5fc5\u987b\u5c06 systemd \u914d\u7f6e\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6\u7684 cgroup \u9a71\u52a8\u3002 https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#systemd-cgroup-driver","title":"systemd cgroup \u9a71\u52a8"},{"location":"my-kubernetes/k8s_installation/#systemd-containerd-cgroup","text":"\u4f7f\u7528 containerd \u4f5c\u4e3a CRI \u8fd0\u884c\u65f6\u7684\u5fc5\u8981\u6b65\u9aa4\u3002 \u5728\u8def\u5f84 /etc/containerd/config.toml \u4e0b\u627e\u5230\u914d\u7f6e\u6587\u4ef6\u3002\u5728 Linux \u4e0a\uff0ccontainerd \u7684\u9ed8\u8ba4 CRI \u5957\u63a5\u5b57\u662f /run/containerd/containerd.sock \u3002 \u7ed3\u5408 runc \u4f7f\u7528 systemd cgroup \u9a71\u52a8\uff0c\u5728 /etc/containerd/config.toml \u4e2d\u8bbe\u7f6e\uff1a [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc] ... [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] SystemdCgroup = true \u8bf4\u660e\uff1a \u5982\u679c\u4f60\u4ece\u8f6f\u4ef6\u5305\uff08\u4f8b\u5982\uff0cRPM \u6216\u8005 .deb\uff09\u4e2d\u5b89\u88c5 containerd\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u5176\u4e2d\u9ed8\u8ba4\u7981\u6b62\u4e86 CRI \u96c6\u6210\u63d2\u4ef6\u3002 \u4f60\u9700\u8981\u542f\u7528 CRI \u652f\u6301\u624d\u80fd\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528 containerd\u3002 \u8981\u786e\u4fdd cri \u6ca1\u6709\u51fa\u73b0\u5728 /etc/containerd/config.toml \u6587\u4ef6\u4e2d disabled_plugins \u5217\u8868\u5185\u3002\u5982\u679c\u4f60\u66f4\u6539\u4e86\u8fd9\u4e2a\u6587\u4ef6\uff0c\u4e5f\u8bf7\u8bb0\u5f97\u8981\u91cd\u542f containerd\u3002 \u5982\u679c\u4f60\u5e94\u7528\u6b64\u66f4\u6539\uff0c\u8bf7\u786e\u4fdd\u91cd\u65b0\u542f\u52a8 containerd\uff1a sudo systemctl restart containerd","title":"\u5c06 systemd \u914d\u7f6e\u4e3a containerd \u7684 cgroup \u9a71\u52a8"},{"location":"my-kubernetes/k8s_installation/#linux-kubectl","text":"","title":"\u5728 Linux \u7cfb\u7edf\u4e2d\u5b89\u88c5 kubectl \u53ca\u5176\u63d2\u4ef6"},{"location":"my-kubernetes/k8s_installation/#kubectl","text":"https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s && cd /usr/nzhong/k8s # Download the latest stable version. #curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\" # Get the latest stable version. #curl -L -s https://dl.k8s.io/release/stable.txt # Download the particular version of \"v1.26.0\". curl -LO https://dl.k8s.io/release/v1.26.0/bin/linux/amd64/kubectl # Install kubectl. sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl # Verify the installed version. kubectl version --client","title":"kubectl \u7684\u4e8c\u8fdb\u5236\u5b89\u88c5"},{"location":"my-kubernetes/k8s_installation/#kubectl_1","text":"\u4e3a\u4e86\u8ba9 kubectl \u80fd\u53d1\u73b0\u5e76\u8bbf\u95ee Kubernetes \u96c6\u7fa4\uff0c\u4f60\u9700\u8981\u4e00\u4e2a kubeconfig \u6587\u4ef6\u3002 \u901a\u5e38 kubectl \u7684\u914d\u7f6e\u4fe1\u606f\u5b58\u653e\u4e8e\u6587\u4ef6 ~/.kube/config \u4e2d\u3002 \u901a\u8fc7\u83b7\u53d6\u96c6\u7fa4\u72b6\u6001\u7684\u65b9\u6cd5\uff0c\u68c0\u67e5\u662f\u5426\u5df2\u6070\u5f53\u7684\u914d\u7f6e\u4e86 kubectl\uff0c\u5982\u679c\u8fd4\u56de\u4e00\u4e2a URL\uff0c\u5219\u610f\u5473\u7740 kubectl \u6210\u529f\u7684\u8bbf\u95ee\u5230\u4e86\u4f60\u7684\u96c6\u7fa4\u3002 kubectl cluster-info","title":"\u9a8c\u8bc1 kubectl \u914d\u7f6e"},{"location":"my-kubernetes/k8s_installation/#shell","text":"TODO","title":"shell \u81ea\u52a8\u8865\u5168\u529f\u80fd"},{"location":"my-kubernetes/k8s_installation/#kubectl-convert","text":"kubectl-convert \u5141\u8bb8\u4f60\u5c06\u6e05\u5355\u5728\u4e0d\u540c API \u7248\u672c\u95f4\u8f6c\u6362\u3002 \u8fd9\u5bf9\u4e8e\u5c06\u6e05\u5355\u8fc1\u79fb\u5230\u65b0\u7684 Kubernetes \u53d1\u884c\u7248\u4e0a\u672a\u88ab\u5e9f\u5f03\u7684 API \u7248\u672c\u65f6\u5c24\u5176\u6709\u5e2e\u52a9\u3002 # Download the latest kubectl-convert package. curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl-convert\" # Install kubectl-convert. sudo install -o root -g root -m 0755 kubectl-convert /usr/local/bin/kubectl-convert # Verify the installed version. kubectl convert --help","title":"\u5b89\u88c5 kubectl convert \u63d2\u4ef6"},{"location":"my-kubernetes/k8s_installation/#kubeadm","text":"\u51c6\u5907\u5de5\u4f5c Linux \u4e3b\u673a\u3002Kubernetes \u9879\u76ee\u4e3a\u57fa\u4e8e Debian \u548c Red Hat \u7684 Linux \u53d1\u884c\u7248\u4ee5\u53ca\u4e00\u4e9b\u4e0d\u63d0\u4f9b\u5305\u7ba1\u7406\u5668\u7684\u53d1\u884c\u7248\u63d0\u4f9b\u901a\u7528\u7684\u6307\u4ee4\u3002 \u6bcf\u53f0\u673a\u5668 2 GB \u6216\u66f4\u591a\u7684 RAM\uff08\u5982\u679c\u5c11\u4e8e\u8fd9\u4e2a\u6570\u5b57\u5c06\u4f1a\u5f71\u54cd\u4f60\u5e94\u7528\u7684\u8fd0\u884c\u5185\u5b58\uff09\u3002 CPU 2 \u6838\u5fc3\u53ca\u4ee5\u4e0a\u3002 \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u673a\u5668\u7684\u7f51\u7edc\u5f7c\u6b64\u5747\u80fd\u76f8\u4e92\u8fde\u63a5\uff08\u516c\u7f51\u548c\u5185\u7f51\u90fd\u53ef\u4ee5\uff09\u3002 \u8282\u70b9\u4e4b\u4e2d\u4e0d\u53ef\u4ee5\u6709\u91cd\u590d\u7684\u4e3b\u673a\u540d\u3001MAC \u5730\u5740\u6216 product_uuid\u3002 \u5f00\u542f\u673a\u5668\u4e0a\u7684\u67d0\u4e9b\u7aef\u53e3\u3002 \u7981\u7528\u4ea4\u6362\u5206\u533a\u3002\u4e3a\u4e86\u4fdd\u8bc1 kubelet \u6b63\u5e38\u5de5\u4f5c\uff0c\u4f60\u5fc5\u987b\u7981\u7528\u4ea4\u6362\u5206\u533a\u3002","title":"\u4f7f\u7528 kubeadm \u5f15\u5bfc\u96c6\u7fa4"},{"location":"my-kubernetes/k8s_installation/#mac-product_uuid","text":"\u901a\u8fc7\u547d\u4ee4 ip link \u6216 ifconfig -a \u83b7\u53d6\u7f51\u7edc\u63a5\u53e3\u7684 MAC \u5730\u5740\u3002 \u4f7f\u7528\u547d\u4ee4 sudo cat /sys/class/dmi/id/product_uuid \u5bf9 product_uuid \u6821\u9a8c \u91cd\u547d\u540d\u4e3b\u673a\u540d\u4f7f\u8282\u70b9\u65b9\u4fbf\u7ba1\u7406 # \u5efa\u8bae\u624b\u5de5\u64cd\u4f5c hostname ${NEW_HOSTNAME} echo \"${NEW_HOSTNAME}\" > /etc/hostname echo \"HOSTNAME=${NEW_HOSTNAME}\" >> /etc/sysconfig/network echo \"${IP_ADDRESS} ${NEW_HOSTNAME} ${NEW_HOSTNAME}\" >> /etc/hosts","title":"\u786e\u4fdd\u6bcf\u4e2a\u8282\u70b9\u4e0a MAC \u5730\u5740\u548c product_uuid \u7684\u552f\u4e00\u6027"},{"location":"my-kubernetes/k8s_installation/#_2","text":"\u53ef\u4ee5\u4f7f\u7528 netcat \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u68c0\u67e5\u7aef\u53e3\u662f\u5426\u542f\u7528\uff1a nc 127.0.0.1 6443","title":"\u68c0\u67e5\u6240\u9700\u7aef\u53e3"},{"location":"my-kubernetes/k8s_installation/#kubeadmkubelet","text":"kubeadm \uff1a\u7528\u6765\u521d\u59cb\u5316\u96c6\u7fa4\u7684\u6307\u4ee4\u3002 kubelet \uff1a\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7528\u6765\u542f\u52a8 Pod \u548c\u5bb9\u5668\u7b49\u3002 kubectl \uff1a\u7528\u6765\u4e0e\u96c6\u7fa4\u901a\u4fe1\u7684\u547d\u4ee4\u884c\u5de5\u5177\u3002 \u57fa\u4e8e Red Hat \u7cfb\u53d1\u884c\u7248 # \u914d\u7f6eyum repo\uff0c\u5899\u5185\u7528\u6237\u53ef\u914d\u7f6e\u5176\u4ed6\u6e90 cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF # Install epel-release as yum repo for CentOS 7 servers. yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm # \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\uff08\u76f8\u5f53\u4e8e\u5c06\u5176\u7981\u7528\uff09 # \u901a\u8fc7\u8fd0\u884c\u547d\u4ee4 setenforce 0 \u548c sed ... \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\u53ef\u4ee5\u6709\u6548\u5730\u5c06\u5176\u7981\u7528\u3002\u8fd9\u662f\u5141\u8bb8\u5bb9\u5668\u8bbf\u95ee\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u6240\u5fc5\u9700\u7684\uff0c\u800c\u8fd9\u4e9b\u64cd\u4f5c\u662f\u4e3a\u4e86\u4f8b\u5982 Pod \u7f51\u7edc\u5de5\u4f5c\u6b63\u5e38\u3002 # \u4f60\u5fc5\u987b\u8fd9\u4e48\u505a\uff0c\u76f4\u5230 kubelet \u505a\u51fa\u5bf9 SELinux \u7684\u652f\u6301\u8fdb\u884c\u5347\u7ea7\u4e3a\u6b62\u3002 sudo setenforce 0 && sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config # \u5173\u95ed\u865a\u62df\u5185\u5b58\u5206\u533a\uff0c\u9632\u6b62 k8s \u7684 pod \u88ab\u5206\u914d\u5230\u865a\u62df\u5185\u5b58\u8fd0\u884c\uff0c\u4ece\u800c\u5f71\u54cd\u4ea7\u7ebf\u8fd0\u884c\u6548\u80fd\u3002\u9700\u8981 reboot\u3002 sudo swapoff -a && sudo sed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes sudo systemctl enable --now kubelet","title":"\u5b89\u88c5 kubeadm\u3001kubelet"},{"location":"my-kubernetes/k8s_installation/#kubeadm_1","text":"\u521d\u59cb\u5316 kubeadm \u914d\u7f6e\u6587\u4ef6 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/k8s/config && cd /usr/nzhong/k8s/config # Export default init config. kubeadm config print init-defaults > kubeadm-config-init-defaults.yaml # Export default join config. kubeadm config print join-defaults > kubeadm-config-join-defaults.yaml \u6839\u636e kubeadm \u914d\u7f6e (v1beta3) \u624b\u5de5\u4fee\u6539\u4e0a\u8ff0\u751f\u6210\u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\uff0c \u5220\u9664\u4f60\u4e0d\u786e\u5b9a\u7684\u5b57\u6bb5 \u3002","title":"kubeadm \u521d\u59cb\u5316\u96c6\u7fa4"},{"location":"my-kubernetes/k8s_installation/#kubeadm-v1beta3","text":"init-defaults apiVersion: kubeadm.k8s.io/v1beta3 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 1.2.3.4 bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: node taints: null --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: {} etcd: local: dataDir: /var/lib/etcd imageRepository: registry.k8s.io kind: ClusterConfiguration kubernetesVersion: 1.26.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 scheduler: {} \u66f4\u65b0 apiVersion: kubeadm.k8s.io/v1beta3 kind: InitConfiguration localAPIEndpoint: advertiseAddress: 10.225.36.57 bindPort: 6443 nodeRegistration: criSocket: unix:///run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: k8s-master-1 --- apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: nzhong-k8s-hz01 #controllerManager: {} #dns: {} apiServer: timeoutForControlPlane: 4m0s etcd: local: imageRepository: \"gcr.io/etcd-development\" imageTag: \"v3.4.23\" dataDir: /var/lib/etcd imageRepository: registry.k8s.io kind: ClusterConfiguration kubernetesVersion: 1.26.0 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/16 podSubnet: 10.100.0.0/16 --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration # kubelet specific options here cgroupDriver: systemd --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration","title":"kubeadm \u914d\u7f6e (v1beta3)"},{"location":"my-kubernetes/k8s_installation/#_3","text":"kubeadm init --config=kubeadm-init.yaml --upload-certs | tee kubeadm-log.log mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config root\u7528\u6237 export KUBECONFIG=/etc/kubernetes/admin.conf","title":"\u521d\u59cb\u5316\u63a7\u5236\u5e73\u9762(\u4e3b\u63a7\u8282\u70b9)"},{"location":"my-kubernetes/k8s_installation/#cni","text":"cat << EOF | tee /etc/cni/net.d/10-containerd-net.conflist { \"cniVersion\": \"1.0.0\", \"name\": \"containerd-net\", \"plugins\": [ { \"type\": \"bridge\", \"bridge\": \"cni0\", \"isGateway\": true, \"ipMasq\": true, \"promiscMode\": true, \"ipam\": { \"type\": \"host-local\", \"ranges\": [ [{ \"subnet\": \"10.96.0.0/16\" }], [{ \"subnet\": \"10.100.0.0/16\" }] ], \"routes\": [ { \"dst\": \"0.0.0.0/0\" }, { \"dst\": \"::/0\" } ] } }, { \"type\": \"portmap\", \"capabilities\": {\"portMappings\": true}, \"externalSetMarkChain\": \"KUBE-MARK-MASQ\" } ] } EOF","title":"CNI\u63d2\u4ef6\u914d\u7f6e"},{"location":"my-kubernetes/k8s_installation_calico/","text":"Kubernetes \u5b89\u88c5 Calico \u7f51\u7edc\u7ec4\u4ef6 # \u53c2\u8003 \u65b9\u5f0f\u4e00: \u4f7f\u7528 Kubernetes API datastore \u5b89\u88c5 Calico\uff0c50\u4e2a\u6216\u66f4\u5c11\u8282\u70b9 # wget https://docs.projectcalico.org/manifests/calico.yaml --no-check-certificate","title":"Kubernetes \u5b89\u88c5 Calico \u7f51\u7edc\u7ec4\u4ef6"},{"location":"my-kubernetes/k8s_installation_calico/#kubernetes-calico","text":"\u53c2\u8003","title":"Kubernetes \u5b89\u88c5 Calico \u7f51\u7edc\u7ec4\u4ef6"},{"location":"my-kubernetes/k8s_installation_calico/#kubernetes-api-datastore-calico50","text":"wget https://docs.projectcalico.org/manifests/calico.yaml --no-check-certificate","title":"\u65b9\u5f0f\u4e00: \u4f7f\u7528 Kubernetes API datastore \u5b89\u88c5 Calico\uff0c50\u4e2a\u6216\u66f4\u5c11\u8282\u70b9"},{"location":"my-kubernetes/k8s_installation_cr/","text":"Kubernetes \u5bb9\u5668\u8fd0\u884c\u65f6\u5b89\u88c5 # \u4f60\u9700\u8981\u5728\u96c6\u7fa4\u5185\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5\u4e00\u4e2a \u5bb9\u5668\u8fd0\u884c\u65f6 \u4ee5\u4f7f Pod \u53ef\u4ee5\u8fd0\u884c\u5728\u4e0a\u9762\u3002 \u672c\u6587\u6982\u8ff0\u4e86\u6240\u6d89\u53ca\u7684\u5185\u5bb9\u5e76\u63cf\u8ff0\u4e86\u4e0e\u8282\u70b9\u8bbe\u7f6e\u76f8\u5173\u7684\u4efb\u52a1\u3002 \u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd) # \u4e8c\u8fdb\u5236\u5b89\u88c5\uff1acontainerd, runc, CNI\u3002 \u53c2\u8003 Getting started with containerd 1. \u5b89\u88c5 containerd # \u4e0b\u8f7d containerd \u4e8c\u8fdb\u5236\u5305\uff1a https://github.com/containerd/containerd/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a containerd-<VERSION>-<OS>-<ARCH>.tar.gz \u3002\u89e3\u538b\u5230 /usr/local \u76ee\u5f55\u4e0b # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download the containerd package, from https://github.com/containerd/containerd/releases wget https://github.com/containerd/containerd/releases/download/v1.6.12/containerd-1.6.12-linux-amd64.tar.gz # Extract it under /usr/local tar Cxzvf /usr/local containerd-1.6.12-linux-amd64.tar.gz \u5982\u679c\u901a\u8fc7 systemd \u542f\u52a8 containerd \uff0c \u9700\u8981\u4ece https://raw.githubusercontent.com/containerd/containerd/main/containerd.service \u4e0b\u8f7d containerd.service \u5355\u5143\u5230\u76ee\u5f55 /etc/systemd/system/containerd.service \u4e0b\uff0c\u7136\u540e\uff1a # Download containerd.service for systemd. wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service # Copy Unit \"containerd.service unit\" to systemd directory. cp ./containerd.service /etc/systemd/system/containerd.service systemctl daemon-reload systemctl enable --now containerd 2. \u5b89\u88c5 runc # \u4e0b\u8f7d runc \u5b89\u88c5\u5305\uff1a https://github.com/opencontainers/runc/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a runc.<ARCH> \u3002\u5b89\u88c5\u5230 /usr/local/sbin/runc \u76ee\u5f55\u4e0b\u3002 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download runc package by specific version of \"v1.1.4\". wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64 # Install install -m 755 runc.amd64 /usr/local/sbin/runc \u9a8c\u8bc1 runc \u5b89\u88c5 runc --version \u5982\u679c\u7f3a\u5c11\u4f9d\u8d56\u5305 libseccomp (\u5c24\u5176\u662f CentOS7 \u4e0b yum \u4e0b\u8f7d\u5b89\u88c5\u7684 libseccomp \u7248\u672c<2.3\uff0c\u65e0\u6cd5\u6ee1\u8db3 containerd \u7684\u9700\u6c42)\u3002 \u6b64\u65f6\u9700\u8981\u5b89\u88c5\u9ad8\u7248\u672c libseccomp # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # \u67e5\u770b\u6240\u5b89\u88c5\u7684 libseccomp \u7248\u672c rpm -qa | grep libseccomp # \u5378\u8f7d\u4f4e\u7248\u672c libseccomp # rpm -e libseccomp-2.3xxxxx --nodeps # rpm -e libseccomp-2.3.1-4.el7.x86_64 --nodeps wget http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm rpm -ivh libseccomp-2.5.1-1.el8.x86_64.rpm rpm -qa | grep libseccomp runc --version 3. \u5b89\u88c5 CNI \u63d2\u4ef6 # \u4e0b\u8f7d CNI \u5b89\u88c5\u5305\uff1a https://github.com/containernetworking/plugins/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a cni-plugins-<OS>-<ARCH>-<VERSION>.tgz \u3002\u89e3\u538b\u5230 /opt/cni/bin \u76ee\u5f55\u4e0b\u3002 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download cni package by specific version of \"v1.1.1\". wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz # Make directory and extract package. mkdir -p /opt/cni/bin tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz 4. \u914d\u7f6e containerd # containerd \u901a\u8fc7\u914d\u7f6e\u6587\u4ef6 /etc/containerd/config.toml \u6765\u6307\u5b9a\u5b88\u62a4\u8fdb\u7a0b\u7684\u914d\u7f6e\u3002 [ \u914d\u7f6e\u53c2\u8003 ] \u751f\u6210\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u3002 # Configure containerd with default options sample. mkdir -p /etc/containerd containerd config default > /etc/containerd/config.toml systemctl restart containerd \u67e5\u770b\u5b89\u88c5\u72b6\u6001 containerd -v ctr version 5. \u5b89\u88c5 nerdctl # # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd wget https://github.com/containerd/nerdctl/releases/download/v1.1.0/nerdctl-1.1.0-linux-amd64.tar.gz tar -zxvf nerdctl-1.1.0-linux-amd64.tar.gz nerdctl && mv nerdctl /usr/local/bin/ nerdctl version","title":"Kubernetes \u5bb9\u5668\u8fd0\u884c\u65f6\u5b89\u88c5"},{"location":"my-kubernetes/k8s_installation_cr/#kubernetes","text":"\u4f60\u9700\u8981\u5728\u96c6\u7fa4\u5185\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5\u4e00\u4e2a \u5bb9\u5668\u8fd0\u884c\u65f6 \u4ee5\u4f7f Pod \u53ef\u4ee5\u8fd0\u884c\u5728\u4e0a\u9762\u3002 \u672c\u6587\u6982\u8ff0\u4e86\u6240\u6d89\u53ca\u7684\u5185\u5bb9\u5e76\u63cf\u8ff0\u4e86\u4e0e\u8282\u70b9\u8bbe\u7f6e\u76f8\u5173\u7684\u4efb\u52a1\u3002","title":"Kubernetes \u5bb9\u5668\u8fd0\u884c\u65f6\u5b89\u88c5"},{"location":"my-kubernetes/k8s_installation_cr/#containerd","text":"\u4e8c\u8fdb\u5236\u5b89\u88c5\uff1acontainerd, runc, CNI\u3002 \u53c2\u8003 Getting started with containerd","title":"\u5bb9\u5668\u8fd0\u884c\u65f6\u73af\u5883\u5b89\u88c5 (containerd)"},{"location":"my-kubernetes/k8s_installation_cr/#1-containerd","text":"\u4e0b\u8f7d containerd \u4e8c\u8fdb\u5236\u5305\uff1a https://github.com/containerd/containerd/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a containerd-<VERSION>-<OS>-<ARCH>.tar.gz \u3002\u89e3\u538b\u5230 /usr/local \u76ee\u5f55\u4e0b # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download the containerd package, from https://github.com/containerd/containerd/releases wget https://github.com/containerd/containerd/releases/download/v1.6.12/containerd-1.6.12-linux-amd64.tar.gz # Extract it under /usr/local tar Cxzvf /usr/local containerd-1.6.12-linux-amd64.tar.gz \u5982\u679c\u901a\u8fc7 systemd \u542f\u52a8 containerd \uff0c \u9700\u8981\u4ece https://raw.githubusercontent.com/containerd/containerd/main/containerd.service \u4e0b\u8f7d containerd.service \u5355\u5143\u5230\u76ee\u5f55 /etc/systemd/system/containerd.service \u4e0b\uff0c\u7136\u540e\uff1a # Download containerd.service for systemd. wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service # Copy Unit \"containerd.service unit\" to systemd directory. cp ./containerd.service /etc/systemd/system/containerd.service systemctl daemon-reload systemctl enable --now containerd","title":"1. \u5b89\u88c5 containerd"},{"location":"my-kubernetes/k8s_installation_cr/#2-runc","text":"\u4e0b\u8f7d runc \u5b89\u88c5\u5305\uff1a https://github.com/opencontainers/runc/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a runc.<ARCH> \u3002\u5b89\u88c5\u5230 /usr/local/sbin/runc \u76ee\u5f55\u4e0b\u3002 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download runc package by specific version of \"v1.1.4\". wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64 # Install install -m 755 runc.amd64 /usr/local/sbin/runc \u9a8c\u8bc1 runc \u5b89\u88c5 runc --version \u5982\u679c\u7f3a\u5c11\u4f9d\u8d56\u5305 libseccomp (\u5c24\u5176\u662f CentOS7 \u4e0b yum \u4e0b\u8f7d\u5b89\u88c5\u7684 libseccomp \u7248\u672c<2.3\uff0c\u65e0\u6cd5\u6ee1\u8db3 containerd \u7684\u9700\u6c42)\u3002 \u6b64\u65f6\u9700\u8981\u5b89\u88c5\u9ad8\u7248\u672c libseccomp # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # \u67e5\u770b\u6240\u5b89\u88c5\u7684 libseccomp \u7248\u672c rpm -qa | grep libseccomp # \u5378\u8f7d\u4f4e\u7248\u672c libseccomp # rpm -e libseccomp-2.3xxxxx --nodeps # rpm -e libseccomp-2.3.1-4.el7.x86_64 --nodeps wget http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm rpm -ivh libseccomp-2.5.1-1.el8.x86_64.rpm rpm -qa | grep libseccomp runc --version","title":"2. \u5b89\u88c5 runc"},{"location":"my-kubernetes/k8s_installation_cr/#3-cni","text":"\u4e0b\u8f7d CNI \u5b89\u88c5\u5305\uff1a https://github.com/containernetworking/plugins/releases \u3002 \u5305\u540d\u7684\u7ed3\u6784\uff1a cni-plugins-<OS>-<ARCH>-<VERSION>.tgz \u3002\u89e3\u538b\u5230 /opt/cni/bin \u76ee\u5f55\u4e0b\u3002 # Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd # Download cni package by specific version of \"v1.1.1\". wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz # Make directory and extract package. mkdir -p /opt/cni/bin tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz","title":"3. \u5b89\u88c5 CNI \u63d2\u4ef6"},{"location":"my-kubernetes/k8s_installation_cr/#4-containerd","text":"containerd \u901a\u8fc7\u914d\u7f6e\u6587\u4ef6 /etc/containerd/config.toml \u6765\u6307\u5b9a\u5b88\u62a4\u8fdb\u7a0b\u7684\u914d\u7f6e\u3002 [ \u914d\u7f6e\u53c2\u8003 ] \u751f\u6210\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u3002 # Configure containerd with default options sample. mkdir -p /etc/containerd containerd config default > /etc/containerd/config.toml systemctl restart containerd \u67e5\u770b\u5b89\u88c5\u72b6\u6001 containerd -v ctr version","title":"4. \u914d\u7f6e containerd"},{"location":"my-kubernetes/k8s_installation_cr/#5-nerdctl","text":"# Make folder to save installation packages and configuration files. mkdir -p /usr/nzhong/containerd && cd /usr/nzhong/containerd wget https://github.com/containerd/nerdctl/releases/download/v1.1.0/nerdctl-1.1.0-linux-amd64.tar.gz tar -zxvf nerdctl-1.1.0-linux-amd64.tar.gz nerdctl && mv nerdctl /usr/local/bin/ nerdctl version","title":"5. \u5b89\u88c5 nerdctl"},{"location":"my-kubernetes/k8s_installation_tools/","text":"Kubernetes \u96c6\u7fa4\u5e38\u7528\u5de5\u5177 # \u670d\u52a1\u4e8e\u6545\u969c\u6392\u67e5\u3001\u8fd0\u7ef4\u7b49\u3002 crictl # \u5b89\u88c5 crictl # cri-tools Release \u914d\u7f6e # \u4f60\u53ef\u4ee5\u7528\u4ee5\u4e0b\u65b9\u6cd5\u4e4b\u4e00\u6765\u4e3a crictl \u8bbe\u7f6e\u7aef\u70b9\uff08endpoint\uff09\uff1a \u8bbe\u7f6e\u53c2\u6570 --runtime-endpoint \u548c --image-endpoint \u3002 \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf CONTAINER_RUNTIME_ENDPOINT \u548c IMAGE_SERVICE_ENDPOINT \u3002 \u5728\u914d\u7f6e\u6587\u4ef6 --config=/etc/crictl.yaml \u4e2d\u8bbe\u7f6e\u7aef\u70b9\u3002\u8981\u8bbe\u7f6e\u4e0d\u540c\u7684\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u8fd0\u884c crictl \u65f6\u4f7f\u7528 --config=PATH_TO_FILE \u6807\u5fd7\u3002 \u8bf7\u67e5\u770b\u6216\u7f16\u8f91 /etc/crictl.yaml \u7684\u5185\u5bb9 runtime-endpoint: unix:///var/run/containerd/containerd.sock image-endpoint: unix:///var/run/containerd/containerd.sock timeout: 10 debug: true \u73af\u5883\u53d8\u91cf\u8bbe\u7f6e export CONTAINER_RUNTIME_ENDPOINT=unix:///var/run/containerd/containerd.sock export IMAGE_SERVICE_ENDPOINT=unix:///var/run/containerd/containerd.sock \u8fdb\u4e00\u6b65\u4e86\u89e3\uff1a crictl \u6587\u6863","title":"Kubernetes \u96c6\u7fa4\u5e38\u7528\u5de5\u5177"},{"location":"my-kubernetes/k8s_installation_tools/#kubernetes","text":"\u670d\u52a1\u4e8e\u6545\u969c\u6392\u67e5\u3001\u8fd0\u7ef4\u7b49\u3002","title":"Kubernetes \u96c6\u7fa4\u5e38\u7528\u5de5\u5177"},{"location":"my-kubernetes/k8s_installation_tools/#crictl","text":"","title":"crictl"},{"location":"my-kubernetes/k8s_installation_tools/#crictl_1","text":"cri-tools Release","title":"\u5b89\u88c5 crictl"},{"location":"my-kubernetes/k8s_installation_tools/#_1","text":"\u4f60\u53ef\u4ee5\u7528\u4ee5\u4e0b\u65b9\u6cd5\u4e4b\u4e00\u6765\u4e3a crictl \u8bbe\u7f6e\u7aef\u70b9\uff08endpoint\uff09\uff1a \u8bbe\u7f6e\u53c2\u6570 --runtime-endpoint \u548c --image-endpoint \u3002 \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf CONTAINER_RUNTIME_ENDPOINT \u548c IMAGE_SERVICE_ENDPOINT \u3002 \u5728\u914d\u7f6e\u6587\u4ef6 --config=/etc/crictl.yaml \u4e2d\u8bbe\u7f6e\u7aef\u70b9\u3002\u8981\u8bbe\u7f6e\u4e0d\u540c\u7684\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u8fd0\u884c crictl \u65f6\u4f7f\u7528 --config=PATH_TO_FILE \u6807\u5fd7\u3002 \u8bf7\u67e5\u770b\u6216\u7f16\u8f91 /etc/crictl.yaml \u7684\u5185\u5bb9 runtime-endpoint: unix:///var/run/containerd/containerd.sock image-endpoint: unix:///var/run/containerd/containerd.sock timeout: 10 debug: true \u73af\u5883\u53d8\u91cf\u8bbe\u7f6e export CONTAINER_RUNTIME_ENDPOINT=unix:///var/run/containerd/containerd.sock export IMAGE_SERVICE_ENDPOINT=unix:///var/run/containerd/containerd.sock \u8fdb\u4e00\u6b65\u4e86\u89e3\uff1a crictl \u6587\u6863","title":"\u914d\u7f6e"},{"location":"my-kubernetes/kubernetes/","text":"graph TD A[Client] --> B[Load Balancer] B --> C[Server01] --> E[\u4f1a\u4e86] --> D[Server02] B --> D[Server02] B --> E[Server02]","title":"Kubernetes"}]}